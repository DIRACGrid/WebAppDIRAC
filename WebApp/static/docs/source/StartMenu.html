<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Ext-dirac-views-desktop-StartMenu'>/**
</span> * @class Ext.dirac.views.desktop.StartMenu Startmenu as a part of the taskbar.
 *        An object of this class has two main parts: - Menu (on the left side) -
 *        Toolbar (on the right side)
 * @extends Ext.panel.Panel
 */
Ext.define(&#39;Ext.dirac.views.desktop.StartMenu&#39;, {
      extend : &#39;Ext.panel.Panel&#39;,

      requires : [&#39;Ext.menu.Menu&#39;, &#39;Ext.toolbar.Toolbar&#39;, &#39;Ext.panel.Panel&#39;, &quot;Ext.button.Button&quot;, &quot;Ext.form.field.Text&quot;],

<span id='Ext-dirac-views-desktop-StartMenu-property-ariaRole'>      ariaRole : &#39;menu&#39;,
</span>
<span id='Ext-dirac-views-desktop-StartMenu-property-cls'>      cls : &#39;x-menu ux-start-menu&#39;,
</span>
<span id='Ext-dirac-views-desktop-StartMenu-property-defaultAlign'>      defaultAlign : &#39;bl-tl&#39;,
</span>
<span id='Ext-dirac-views-desktop-StartMenu-property-iconCls'>      iconCls : &#39;ux-start-button-icon&#39;,
</span>
<span id='Ext-dirac-views-desktop-StartMenu-property-height'>      height : 300,
</span>
<span id='Ext-dirac-views-desktop-StartMenu-property-floating'>      floating : true,
</span>
<span id='Ext-dirac-views-desktop-StartMenu-property-shadow'>      shadow : true,
</span>
<span id='Ext-dirac-views-desktop-StartMenu-property-width'>      /*
</span>       * We have to hardcode a width because the internal Menu cannot drive our
       * width. This is combined with changing the align property of the menu&#39;s
       * layout from the typical &#39;stretchmax&#39; to &#39;stretch&#39; which allows the the
       * items to fill the menu area.
       */
      width : 230,

<span id='Ext-dirac-views-desktop-StartMenu-method-initComponent'>      initComponent : function() {
</span>        var me = this;

        /*
         * Structuring the Start menu
         */

        me.title = ((GLOBAL.APP.configData.user.username) ? GLOBAL.APP.configData[&quot;user&quot;][&quot;username&quot;] + &quot;@&quot; + GLOBAL.APP.configData[&quot;user&quot;][&quot;group&quot;] : &quot;Anonymous&quot;);

        me.menu = new Ext.menu.Menu({
              cls : &#39;ux-start-menu-body&#39;,
              border : false,
              floating : false,
              ignoreParentClicks : true
            });

        me.menu.layout.align = &#39;stretch&#39;;

        me.items = [me.menu];
        me.layout = &#39;fit&#39;;

        Ext.menu.Manager.register(me);

        /*
         * me.toolbar = new Ext.toolbar.Toolbar({ dock : &#39;right&#39;, cls :
         * &#39;ux-start-menu-toolbar&#39;, vertical : true, width : 100 });
         */

        me.callParent(arguments);

        // me.toolbar.layout.align = &#39;stretch&#39;;
        // me.addDocked(me.toolbar);

        delete me.toolItems;

      },

<span id='Ext-dirac-views-desktop-StartMenu-method-afterRender'>      afterRender : function() {
</span>
        var me = this;

        for (var j = 0; j &lt; GLOBAL.APP.configData[&quot;menu&quot;].length; j++)
          me.menu.add(me.getMenuStructureRec(GLOBAL.APP.configData[&quot;menu&quot;][j]));

        if (GLOBAL.STATE_MANAGEMENT_ENABLED) {

          me.menu.add([&#39;-&#39;, {
                text : &#39;State Loader&#39;,
                iconCls : &#39;dirac-icon-state&#39;,
                handler : function() {
                  GLOBAL.APP.MAIN_VIEW.SM.formStateLoader(GLOBAL.APP.MAIN_VIEW.cbAfterLoadSharedState, GLOBAL.APP.MAIN_VIEW.cbAfterSaveSharedState);
                }
              }]);

        }

        this.callParent();
      },

<span id='Ext-dirac-views-desktop-StartMenu-method-addMenuItem'>      /**
</span>       * Function to add an item (button, menu) to the menu of the start menu
       */
      addMenuItem : function() {
        var cmp = this.menu;
        cmp.add.apply(cmp, arguments);
      },

<span id='Ext-dirac-views-desktop-StartMenu-method-addToolItem'>      /**
</span>       * Function to add an item (button, menu) to the toolbar of the start menu
       */
      addToolItem : function() {
        var cmp = this.toolbar;
        cmp.add.apply(cmp, arguments);
      },

<span id='Ext-dirac-views-desktop-StartMenu-method-showBy'>      showBy : function(cmp, pos, off) {
</span>        var me = this;

        if (me.floating &amp;&amp; cmp) {
          me.layout.autoSize = true;
          me.show();

          // Component or Element
          cmp = cmp.el || cmp;

          // Convert absolute to floatParent-relative coordinates if
          // necessary.
          var xy = me.el.getAlignToXY(cmp, pos || me.defaultAlign, off);
          if (me.floatParent) {
            var r = me.floatParent.getTargetEl().getViewRegion();
            xy[0] -= r.x;
            xy[1] -= r.y;
          }
          me.showAt(xy);
          me.doConstrain();
        }
        return me;
      },

<span id='Ext-dirac-views-desktop-StartMenu-method-getMenuStructureRec'>      /**
</span>       * This method is used to recursively read the data about the start menu
       * 
       * @return {Object}
       */
      getMenuStructureRec : function(item) {

        var me = this;

        if (item.length == 2) {

          var result = {
            text : item[0],
            menu : [],
            iconCls : &quot;system_folder&quot;
          };

          for (var i = 0; i &lt; item[1].length; i++)
            result.menu.push(me.getMenuStructureRec(item[1][i]));

          return result;

        } else {
          if (item[0] == &quot;app&quot;) {
            var oParts = item[2].split(&quot;.&quot;);
            var sStartClass = &quot;&quot;;
            if (oParts.length == 2)
              sStartClass = item[2] + &quot;.classes.&quot; + oParts[1];
            else
              sStartClass = item[2];

            return {
              text : item[1],
              minWidth : 200,
              menu : [],
              isStateMenuLoaded : 0,
              appClassName : sStartClass,
              iconCls : &quot;notepad&quot;,
              listeners : {
                render : function(oMenuItem, eOpts) {

                  GLOBAL.APP.MAIN_VIEW.registerStartAppMenu(oMenuItem, oMenuItem.appClassName);

                  oMenuItem.menu.on(&quot;beforeshow&quot;, function(oMenu, eOpts) {

                        if (oMenu.items.length &lt;= 1) {
                          var oElem = Ext.get(oMenuItem.id + &#39;-arrowEl&#39;);

                          if (oElem) {

                            oElem.hide();

                          }
                          return false;
                        } else {
                          var oElem = Ext.get(oMenuItem.id + &#39;-arrowEl&#39;);

                          if (oElem) {

                            oElem.show();

                          }
                          return true;
                        }

                      });

                  var oElem = Ext.get(oMenuItem.id + &#39;-arrowEl&#39;);

                  if (oElem) {

                    oElem.hide();

                  }

                },
                activate : function(oMenuItem, eOpts) {

                },
                click : Ext.bind(GLOBAL.APP.MAIN_VIEW.createWindow, GLOBAL.APP.MAIN_VIEW, [item[0], item[2], null]),
                focus : function(cmp, e, eOpts) {

                  if (!GLOBAL.STATE_MANAGEMENT_ENABLED)
                    return;

                  /*
                   * if the cache for the state of the started application exist
                   */

                  /*
                   * A call to isStateLoaded can be used to see whether the
                   * application states have been loaded
                   */

                  var iAppStatesLoaded = GLOBAL.APP.SM.isStateLoaded(&quot;application&quot;, sStartClass, &quot;|&quot;);// OK

                  if (iAppStatesLoaded != -2) {

                    if (cmp.isStateMenuLoaded != 2) {

                      cmp.oprRefreshAppStates();
                      cmp.isStateMenuLoaded = 2;
                    }

                  } else {
                    if (cmp.isStateMenuLoaded == 0) {
                      cmp.setIconCls(&quot;loading_item&quot;);
                      var oFunc = function(iCode, sAppName) {

                        cmp.oprRefreshAppStates();
                        cmp.isStateMenuLoaded = 2;
                        cmp.setIconCls(&quot;notepad&quot;);

                        if (cmp.menu.items.length &lt;= 1) {
                          var oElem = Ext.get(cmp.id + &#39;-arrowEl&#39;);

                          if (oElem) {

                            oElem.hide();

                          }

                        } else {
                          var oElem = Ext.get(cmp.id + &#39;-arrowEl&#39;);

                          if (oElem) {

                            oElem.show();

                          }

                        }

                        /*
                         * var oPos = cmp.getPosition(); var oSize =
                         * cmp.getSize();
                         * 
                         * cmp.menu.showAt(oPos[0] + oSize.width, oPos[1]);
                         */

                      };

                      GLOBAL.APP.SM.oprReadApplicationStatesAndReferences(sStartClass, oFunc);// OK

                      cmp.isStateMenuLoaded = 1;

                    }

                  }

                }

              },
              addNewState : function(stateType, stateName) {

                var oThisMenu = this;
                var oNewItem = null;

                if (stateType == &quot;application&quot;) {

                  oNewItem = Ext.create(&#39;Ext.menu.Item&#39;, {
                        text : stateName,
                        handler : Ext.bind(GLOBAL.APP.MAIN_VIEW.createWindow, GLOBAL.APP.MAIN_VIEW, [&quot;app&quot;, oThisMenu.appClassName, {
                                  stateToLoad : stateName
                                }], false),
                        scope : me,
                        iconCls : &quot;dirac-icon-state&quot;,
                        stateType : stateType,
                        minWidth : 200,
                        menu : [{
                              text : &quot;Share state&quot;,
                              stateName : stateName,
                              handler : function() {
                                var oThisItem = this;

                                GLOBAL.APP.SM.oprShareState(oThisMenu.appClassName, oThisItem.stateName, function(rCode, rAppName, rStateName, rMessage) {

                                      if (rCode == 1) {

                                        var oHtml = &quot;&quot;;
                                        oHtml += &quot;&lt;div style=&#39;padding:5px&#39;&gt;The string you can send is as follows:&lt;/div&gt;&quot;;
                                        oHtml += &quot;&lt;div style=&#39;padding:5px;font-weight:bold&#39;&gt;&quot; + rMessage + &quot;&lt;/div&gt;&quot;;

                                        Ext.MessageBox.alert(&quot;Info for sharing the &lt;span style=&#39;color:red&#39;&gt;&quot; + rStateName + &quot;&lt;/span&gt; state:&quot;, oHtml);

                                      }

                                    });

                              },
                              iconCls : &quot;dirac-icon-share&quot;
                            }, {
                              text : &quot;Make public&quot;,
                              stateName : stateName,
                              handler : function() {
                                var oThisItem = this;

                                GLOBAL.APP.SM.oprPublishState(oThisMenu.appClassName, oThisItem.stateName);

                              },
                              iconCls : &quot;dirac-icon-share&quot;
                            }]
                      });

                  oThisMenu.menu.insert(0, oNewItem);

                } else if (stateType == &quot;reference&quot;) {

                  oNewItem = Ext.create(&#39;Ext.menu.Item&#39;, {
                        text : stateName,
                        minWidth : 200,
                        handler : Ext.bind(GLOBAL.APP.MAIN_VIEW.loadSharedStateByName, GLOBAL.APP.MAIN_VIEW, [oThisMenu.appClassName, stateName], false),
                        scope : me,
                        iconCls : &quot;dirac-icon-link&quot;,
                        stateType : stateType
                      });

                  oThisMenu.menu.add(oNewItem);

                }

              },
              removeState : function(stateType, stateName) {

                var me = this;

                var iStartingIndex = 0;

                switch (stateType) {

                  case &quot;application&quot; :
                    for (var i = 0; i &lt; me.menu.items.length; i++) {

                      if (me.menu.items.getAt(i).self.getName() == &quot;Ext.menu.Separator&quot;)
                        break;

                      if (me.menu.items.getAt(i).text == stateName) {

                        me.menu.remove(me.menu.items.getAt(i));
                        break;

                      }

                    }

                    break;
                  case &quot;reference&quot; :
                    for (var i = me.menu.items.length - 1; i &gt;= 0; i--) {

                      if (me.menu.items.getAt(i).self.getName() == &quot;Ext.menu.Separator&quot;)
                        break;

                      if (me.menu.items.getAt(i).text == stateName) {

                        me.menu.remove(me.menu.items.getAt(i));
                        break;

                      }

                    }
                    break;

                }

              },
              oprRefreshAppStates : function() {

                var oThisMenu = this;

                oThisMenu.menu.removeAll();

                var oStates = GLOBAL.APP.SM.getApplicationStates(&quot;application&quot;, oThisMenu.appClassName);// OK

                for (var i = 0, len = oStates.length; i &lt; len; i++) {

                  var stateName = oStates[i];

                  var newItem = Ext.create(&#39;Ext.menu.Item&#39;, {
                        text : stateName,
                        minWidth : 200,
                        handler : Ext.bind(GLOBAL.APP.MAIN_VIEW.createWindow, GLOBAL.APP.MAIN_VIEW, [&quot;app&quot;, oThisMenu.appClassName, {
                                  stateToLoad : stateName
                                }], false),
                        scope : me,
                        iconCls : &quot;dirac-icon-state&quot;,
                        stateType : &quot;application&quot;,
                        menu : [{
                              text : &quot;Share state&quot;,
                              stateName : stateName,
                              handler : function() {

                                var oThisItem = this;

                                GLOBAL.APP.SM.oprShareState(oThisMenu.appClassName, oThisItem.stateName, function(rCode, rAppName, rStateName, rMessage) {

                                      if (rCode == 1) {

                                        var oHtml = &quot;&quot;;
                                        oHtml += &quot;&lt;div style=&#39;padding:5px&#39;&gt;The string you can send is as follows:&lt;/div&gt;&quot;;
                                        oHtml += &quot;&lt;div style=&#39;padding:5px;font-weight:bold&#39;&gt;&quot; + rMessage + &quot;&lt;/div&gt;&quot;;

                                        Ext.MessageBox.alert(&quot;Info for sharing the &lt;span style=&#39;color:red&#39;&gt;&quot; + rStateName + &quot;&lt;/span&gt; state:&quot;, oHtml);

                                      }

                                    });

                              },
                              iconCls : &quot;dirac-icon-share&quot;
                            }, {
                              text : &quot;Make public&quot;,
                              stateName : stateName,
                              handler : function() {

                                var oThisItem = this;

                                GLOBAL.APP.SM.oprPublishState(oThisMenu.appClassName, oThisItem.stateName);

                              },
                              iconCls : &quot;dirac-icon-share&quot;
                            }]
                      });

                  oThisMenu.menu.add(newItem);

                }

                var oRefs = GLOBAL.APP.SM.getApplicationStates(&quot;reference&quot;, oThisMenu.appClassName);// OK

                // if((oStates.length&gt;0)||(oRefs.length&gt;0))
                oThisMenu.menu.add(&quot;-&quot;);

                for (var i = 0, len = oRefs.length; i &lt; len; i++) {

                  var stateName = oRefs[i];

                  var newItem = Ext.create(&#39;Ext.menu.Item&#39;, {
                        text : stateName,
                        handler : Ext.bind(GLOBAL.APP.MAIN_VIEW.loadSharedStateByName, GLOBAL.APP.MAIN_VIEW, [oThisMenu.appClassName, stateName], false),
                        scope : me,
                        iconCls : &quot;dirac-icon-link&quot;,
                        minWidth : 200,
                        stateType : &quot;reference&quot;
                      });

                  oThisMenu.menu.add(newItem);

                }

              }
            };

          } else {

            return {
              text : item[1],
              handler : Ext.bind(GLOBAL.APP.MAIN_VIEW.createWindow, GLOBAL.APP.MAIN_VIEW, [item[0], item[2], {
                        title : item[1]
                      }]),
              minWidth : 200,
              iconCls : &quot;system_web_window&quot;
            };

          }

        }

      }

    });
</pre>
</body>
</html>
