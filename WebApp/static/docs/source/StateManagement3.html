<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Ext-dirac-core-StateManagement'>/**
</span> * @class Ext.dirac.core.StateManagement This class manages the state management
 *        within the Desktop view
 * 
 */

Ext.define(&#39;Ext.dirac.views.tabs.StateManagement&#39;, {
      requires : [&#39;Ext.form.field.Text&#39;, &#39;Ext.button.Button&#39;, &#39;Ext.toolbar.Toolbar&#39;, &#39;Ext.panel.Panel&#39;, &quot;Ext.window.Window&quot;],

<span id='Ext-dirac-core-StateManagement-method-formSaveState'>      /**
</span>       * Function called when the Save As ... button from the SAVE window menu
       * is clicked
       * 
       * @param {String}
       *          sStateType The type of the state [application|reference]
       * @param {String}
       *          sAppName Application class name
       * @param {Object}
       *          oAppObject The application object
       * @param {Function}
       *          cbAfterSave Function that is executed after the save has been
       *          saved
       */
      formSaveState : function(sStateType, sAppName, oAppObject, cbAfterSave) {

        var me = this;

        me.txtStateName = Ext.create(&#39;Ext.form.field.Text&#39;, {

              fieldLabel : &quot;State Name:&quot;,
              labelAlign : &#39;left&#39;,
              margin : 10,
              width : 400,
              enableKeyEvents : true,
              validateValue : function(sValue) {

                sValue = Ext.util.Format.trim(sValue);

                if (sValue.length &lt; 1) {
                  this.markInvalid(&quot;You must specify a name !&quot;);
                  return false;

                } else {

                  if (GLOBAL.APP.SM.isStateLoaded(sStateType, sAppName, sValue) == 1) {

                    this.markInvalid(&quot;The name you enetered already exists !&quot;);
                    return false;

                  } else {

                    if (GLOBAL.APP.SM.isValidStateName(sValue)) {
                      this.clearInvalid();
                      return true;
                    } else {

                      this.markInvalid(&quot;Allowed characters are: 0-9, a-z, A-Z, &#39;_&#39;, &#39;-&#39;, &#39;.&#39;, &#39; &#39;&quot;);
                      return false;

                    }

                  }

                }

              },
              validateOnChange : true,
              validateOnBlur : false,
              listeners : {

                keypress : function(oTextField, e, eOpts) {

                  if (e.getCharCode() == 13) {

                    if (me.txtStateName.isValid()) {

                      var sStateName = me.txtStateName.getValue();

                      GLOBAL.APP.SM.oprSendDataForSave(sAppName, oAppObject, sStateType, sStateName, cbAfterSave);

                    }

                  }

                }

              }

            });

        // button for saving the state
        me.btnSaveState = new Ext.Button({

              text : &#39;Save&#39;,
              margin : 3,
              iconCls : &quot;dirac-icon-save&quot;,
              handler : function() {

                if (me.txtStateName.isValid()) {

                  var sStateName = me.txtStateName.getValue();

                  GLOBAL.APP.SM.oprSendDataForSave(sAppName, oAppObject, sStateType, sStateName, cbAfterSave);

                }

              },
              scope : me

            });

        // button to close the save form
        me.btnCancelSaveState = new Ext.Button({

              text : &#39;Cancel&#39;,
              margin : 3,
              iconCls : &quot;toolbar-other-close&quot;,
              handler : function() {

                me.txtStateName.setValue(&quot;&quot;);
                me.saveWindow.hide();

              },
              scope : me

            });

        var oToolbar = new Ext.toolbar.Toolbar({
              border : false
            });

        oToolbar.add([me.btnSaveState, me.btnCancelSaveState]);

        var oPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              autoHeight : true,
              border : false,
              items : [oToolbar, me.txtStateName]
            });

        // initializing window showing the saving form
        me.saveWindow = Ext.create(&#39;widget.window&#39;, {
              height : 120,
              width : 500,
              title : &#39;Save state&#39;,
              layout : &#39;fit&#39;,
              modal : true,
              items : oPanel
            });

        me.saveWindow.show();
        me.txtStateName.focus();

      },

<span id='Ext-dirac-core-StateManagement-method-formSaveAsStateOfData'>      /**
</span>       * Function called when the Save As ... button from the SAVE context menu
       * is clicked
       * 
       * @param {String}
       *          sStateType The type of the state [application|reference]
       * @param {String}
       *          sAppName Application class name
       * @param {Object}
       *          oAppObject The application object
       * @param {Function}
       *          cbAfterSave Function that is executed after the save has been
       *          saved
       */
      formSaveAsStateOfData : function(desktop, selectedStateName, sStateType, sAppName, cbAfterSave) {

        var me = this;

        me.txtStateName = Ext.create(&#39;Ext.form.field.Text&#39;, {

              fieldLabel : &quot;State Name:&quot;,
              labelAlign : &#39;left&#39;,
              margin : 10,
              width : 400,
              enableKeyEvents : true,
              validateValue : function(sValue) {

                sValue = Ext.util.Format.trim(sValue);

                if (sValue.length &lt; 1) {
                  this.markInvalid(&quot;You must specify a name !&quot;);
                  return false;

                } else {

                  if (GLOBAL.APP.SM.isStateLoaded(sStateType, sAppName, sValue) == 1) {

                    this.markInvalid(&quot;The name you enetered already exists !&quot;);
                    return false;

                  } else {

                    if (GLOBAL.APP.SM.isValidStateName(sValue)) {
                      this.clearInvalid();
                      return true;
                    } else {

                      this.markInvalid(&quot;Allowed characters are: 0-9, a-z, A-Z, &#39;_&#39;, &#39;-&#39;, &#39;.&#39;, &#39; &#39;&quot;);
                      return false;

                    }

                  }

                }

              },
              validateOnChange : true,
              validateOnBlur : false,
              listeners : {

                keypress : function(oTextField, e, eOpts) {

                  if (e.getCharCode() == 13) {

                    if (me.txtStateName.isValid()) {

                      var sStateName = me.txtStateName.getValue();

                      var desktops = GLOBAL.APP.SM.getStateData(&quot;application&quot;, &quot;desktop&quot;, desktop);
                      var duplicateState = {};
                      for (var i = 0; i &lt; desktops.data.length; i++) {
                        if (desktops.data[i].currentState == selectedStateName &amp;&amp; desktops.data[i].module == sAppName) {
                          duplicateState = Ext.clone(desktops.data[i]);
                          duplicateState.currentState = sStateName;
                          duplicateState.desktop = desktop;
                          break;
                        }
                      }
                      desktops.data.push(duplicateState);
                      me.oprSendDataForSave(&quot;desktop&quot;, desktops, &quot;application&quot;, desktop, function(iCode, appName, stateType, stateName) {
                            cbAfterSave(iCode, appName, stateType, sStateName);
                          });

                    }

                  }

                }

              }

            });

        // button for saving the state
        me.btnSaveState = new Ext.Button({

              text : &#39;Save&#39;,
              margin : 3,
              iconCls : &quot;dirac-icon-save&quot;,
              handler : function() {

                if (me.txtStateName.isValid()) {

                  var sStateName = me.txtStateName.getValue();

                  var desktops = GLOBAL.APP.SM.getStateData(&quot;application&quot;, &quot;desktop&quot;, desktop);
                  var duplicateState = {};
                  for (var i = 0; i &lt; desktops.data.length; i++) {
                    if (desktops.data[i].currentState == selectedStateName &amp;&amp; desktops.data[i].module == sAppName) {
                      duplicateState = Ext.clone(desktops.data[i]);
                      duplicateState.currentState = sStateName;
                      duplicateState.desktop = desktop;
                      break;
                    }
                  }
                  desktops.data.push(duplicateState);
                  me.oprSendDataForSave(&quot;desktop&quot;, desktops, &quot;application&quot;, desktop, function(iCode, appName, stateType, stateName) {
                        cbAfterSave(iCode, appName, stateType, sStateName);
                      });

                }

              },
              scope : me

            });

        // button to close the save form
        me.btnCancelSaveState = new Ext.Button({

              text : &#39;Cancel&#39;,
              margin : 3,
              iconCls : &quot;toolbar-other-close&quot;,
              handler : function() {

                me.txtStateName.setValue(&quot;&quot;);
                me.saveWindow.hide();

              },
              scope : me

            });

        var oToolbar = new Ext.toolbar.Toolbar({
              border : false
            });

        oToolbar.add([me.btnSaveState, me.btnCancelSaveState]);

        var oPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              autoHeight : true,
              border : false,
              items : [oToolbar, me.txtStateName]
            });

        // initializing window showing the saving form
        me.saveWindow = Ext.create(&#39;widget.window&#39;, {
              height : 120,
              width : 500,
              title : &#39;Save state&#39;,
              layout : &#39;fit&#39;,
              modal : true,
              items : oPanel
            });

        me.saveWindow.show();
        me.txtStateName.focus();

      },
<span id='Ext-dirac-core-StateManagement-method-oprSaveAppState'>      /**
</span>       * Function called when the Save button from the SAVE window menu is
       * clicked
       * 
       * @param {String}
       *          sStateType The type of the state [application|reference]
       * @param {String}
       *          sAppName Application class name
       * @param {Object}
       *          oAppObject The application object
       * @param {Function}
       *          cbAfterSave Function that is executed after the save has been
       *          saved
       */
      oprSaveAppState : function(sStateType, sAppName, oAppObject, cbAfterSave) {

        var me = this;

        if (oAppObject.title == &quot;&quot; || oAppObject.title == &#39;Default&#39; || oAppObject.currentState == &quot;&quot;) {
          // It is the default desktop or an application which is not saved
          me.formSaveState(sStateType, sAppName, oAppObject, cbAfterSave);

        } else {
          var stateName = &#39;&#39;;
          if (sAppName == &#39;desktop&#39;) {
            stateName = oAppObject.title;
          } else {
            stateName = oAppObject.currentState;
          }

          GLOBAL.APP.SM.oprSendDataForSave(sAppName, oAppObject, sStateType, stateName, cbAfterSave);

        }
      },

<span id='Ext-dirac-core-StateManagement-method-formManageStates'>      /**
</span>       * Function to create and open the form for managing the desktop states
       * 
       * @param {String}
       *          sAppName Application class name
       * @param {Function}
       *          cbAfterRemove A function to be executed after a state has been
       *          removed
       * 
       */
      formManageStates : function(sAppName, cbAfterRemove) {

        var me = this;

        me.btnDeleteState = new Ext.Button({

              text : &#39;Delete&#39;,
              margin : 3,
              iconCls : &quot;toolbar-other-close&quot;,
              handler : me.oprDeleteSelectedStates,
              scope : me

            });

        var oToolbar = new Ext.toolbar.Toolbar({
              region : &quot;north&quot;,
              border : false
            });

        oToolbar.add([me.btnDeleteState]);

        var oPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              region : &quot;center&quot;,
              border : false,
              bodyPadding : 5,
              autoHeight : true,
              layout : {
                type : &#39;vbox&#39;,
                align : &#39;stretch&#39;
              },
              appName : sAppName,
              cbAfterRemove : cbAfterRemove,
              items : [{
                    xtype : &quot;panel&quot;,
                    layout : &quot;column&quot;,
                    border : false,
                    items : [{
                          xtype : &#39;radiofield&#39;,
                          boxLabel : &#39;States&#39;,
                          inputValue : &#39;s&#39;,
                          name : &quot;manage_state_type&quot;,
                          width : 150,
                          padding : &quot;0 0 5 0&quot;,
                          checked : true,
                          listeners : {

                            change : function(cmp, newValue, oldValue, eOpts) {

                              var oSelectElStates = me.manageWindow.items.getAt(1).items.getAt(1);
                              var oSelectElLinks = me.manageWindow.items.getAt(1).items.getAt(2);

                              if (newValue) {

                                oSelectElStates.show();
                                oSelectElLinks.hide();

                              } else {

                                oSelectElStates.hide();
                                oSelectElLinks.show();

                              }

                            }

                          }
                        }, {
                          xtype : &#39;radiofield&#39;,
                          boxLabel : &#39;Links&#39;,
                          inputValue : &#39;l&#39;,
                          padding : &quot;0 0 5 0&quot;,
                          name : &quot;manage_state_type&quot;,
                          width : 150
                        }]
                  }, {
                    html : &quot;&lt;select multiple=&#39;multiple&#39; style=&#39;width:100%;height:175px&#39;&gt;&lt;/select&gt;&quot;,
                    xtype : &quot;box&quot;
                  }, {
                    html : &quot;&lt;select multiple=&#39;multiple&#39; style=&#39;width:100%;height:175px&#39;&gt;&lt;/select&gt;&quot;,
                    xtype : &quot;box&quot;,
                    hidden : true
                  }]
            });

        // creating the window
        me.manageWindow = Ext.create(&#39;widget.window&#39;, {
              height : 280,
              width : 500,
              title : &#39;Manage states :: &#39; + GLOBAL.APP.getApplicationTitle(sAppName),
              layout : &#39;border&#39;,
              modal : true,
              resizable : false,
              items : [oToolbar, oPanel]
            });

        me.manageWindow.show();

        // filling the lists of the form with states and references
        me.oprFillSelectFieldWithStates();

      },

<span id='Ext-dirac-core-StateManagement-method-oprFillSelectFieldWithStates'>      /**
</span>       * Function to fill the select element with the existing module states
       */
      oprFillSelectFieldWithStates : function() {

        var me = this;
        var oSelectEl = document.getElementById(me.manageWindow.getId()).getElementsByTagName(&quot;select&quot;)[0];

        for (var i = oSelectEl.length - 1; i &gt;= 0; i--) {
          oSelectEl.remove(i);
        }

        var sAppName = me.manageWindow.items.getAt(1).appName;

        var oAppStates = GLOBAL.APP.SM.getApplicationStates(&quot;application&quot;, sAppName);

        for (var i = 0; i &lt; oAppStates.length; i++) {

          if (oAppStates[i] != &#39;Default&#39;) {
            var elOptNew = document.createElement(&#39;option&#39;);

            elOptNew.text = oAppStates[i];
            elOptNew.value = oAppStates[i];

            try {
              oSelectEl.add(elOptNew, null); // standards compliant;
              // doesn&#39;t
              // work in IE
            } catch (ex) {
              oSelectEl.add(elOptNew); // IE only
            }
          }
        }

        oSelectEl = document.getElementById(me.manageWindow.getId()).getElementsByTagName(&quot;select&quot;)[1];

        for (var i = oSelectEl.length - 1; i &gt;= 0; i--) {
          oSelectEl.remove(i);
        }

        var oAppRefs = GLOBAL.APP.SM.getApplicationStates(&quot;reference&quot;, sAppName);

        for (var i = 0; i &lt; oAppRefs.length; i++) {

          var elOptNew = document.createElement(&#39;option&#39;);

          elOptNew.text = oAppRefs[i];
          elOptNew.value = oAppRefs[i];

          try {
            oSelectEl.add(elOptNew, null); // standards compliant; doesn&#39;t
            // work in IE
          } catch (ex) {
            oSelectEl.add(elOptNew); // IE only
          }

        }

      },

<span id='Ext-dirac-core-StateManagement-method-oprDeleteSelectedStates'>      /**
</span>       * Function to delete all selected states or references from the form
       * lists
       */
      oprDeleteSelectedStates : function() {

        var me = this;

        var iWhoSelect = 0;

        var sAppName = me.manageWindow.items.getAt(1).appName;

        if (me.manageWindow.items.getAt(1).items.getAt(0).items.getAt(1).getValue())
          iWhoSelect = 1;

        var oSelectField = document.getElementById(me.manageWindow.getId()).getElementsByTagName(&quot;select&quot;)[iWhoSelect];

        for (var i = oSelectField.length - 1; i &gt;= 0; i--) {

          if (oSelectField.options[i].selected) {

            /*
             * First we check whether there are instances of that state that are
             * active
             */
            var oStateName = oSelectField.options[i].value;

            if (iWhoSelect == 0) {

              if (!GLOBAL.APP.SM.isAnyActiveState(sAppName, oStateName)) {

                var cbFunc = function(rCode, rAppName, rStateType, rStateName) {

                  if (rCode == 1) {
                    me.manageWindow.items.getAt(1).cbAfterRemove(&quot;application&quot;, rAppName, rStateName);
                    for (var j = oSelectField.length - 1; j &gt;= 0; j--) {
                      if (rStateName == oSelectField.options[j].value) {
                        oSelectField.remove(j);
                        break;
                      }
                    }

                  }

                };

                GLOBAL.APP.SM.oprDeleteState(sAppName, &quot;application&quot;, oStateName, cbFunc);

              } else
                GLOBAL.APP.CF.alert(&#39;The state &lt;b&gt;&#39; + oSelectField.options[i].value + &#39;&lt;/b&gt; you are willing to delete is curently in use !&#39;, &#39;warning&#39;);

            } else {

              var cbFunc = function(rCode, rAppName, rStateType, rStateName) {

                if (rCode == 1) {
                  me.manageWindow.items.getAt(1).cbAfterRemove(&quot;reference&quot;, rAppName, rStateName);
                  for (var j = oSelectField.length - 1; j &gt;= 0; j--) {
                    if (rStateName == oSelectField.options[j].value) {
                      oSelectField.remove(j);
                      break;
                    }
                  }
                }

              };

              GLOBAL.APP.SM.oprDeleteState(sAppName, &quot;reference&quot;, oStateName, cbFunc);

            }

          }
        }

      },

<span id='Ext-dirac-core-StateManagement-method-formStateLoader'>      /**
</span>       * Function to create and show the form for saving or loading a shared
       * state
       * 
       * @param {Function}
       *          cbAfterLoad Function to be executed after the shared state has
       *          been loaded
       * @param {Function}
       *          cbAfterSave Function to be executed after the shared state has
       *          been saved
       * 
       */
      formStateLoader : function(cbAfterLoad, cbAfterSave) {

        var me = this;

        me.txtLoadText = Ext.create(&#39;Ext.form.field.Text&#39;, {

              fieldLabel : &quot;Shared State:&quot;,
              labelAlign : &#39;left&#39;,
              margin : 10,
              width : 400,
              validate : function() {
                var me = this;
                var sValue = me.getValue();
                if ((Ext.util.Format.trim(sValue) != &quot;&quot;) &amp;&amp; (sValue.split(&quot;|&quot;).length == 4)) {
                  return true;
                } else {
                  GLOBAL.APP.CF.alert(&quot;The value in the &#39;Shared State&#39; field is not valid !&quot;, &quot;warning&quot;);
                  return false;
                }

              },
              validateOnChange : false,
              validateOnBlur : false

            });

        me.txtRefName = Ext.create(&#39;Ext.form.field.Text&#39;, {

              fieldLabel : &quot;Name:&quot;,
              labelAlign : &#39;left&#39;,
              margin : 10,
              width : 400,
              validate : function() {
                var me = this;

                if (Ext.util.Format.trim(me.getValue()) != &quot;&quot;) {

                  return true;

                } else {
                  GLOBAL.APP.CF.alert(&quot;The &#39;Name&#39; field cannot be empty !&quot;, &quot;warning&quot;);
                  return false;
                }

              },
              validateOnChange : false,
              validateOnBlur : false
            });

        me.btnLoadSharedState = new Ext.Button({

              text : &#39;Load&#39;,
              margin : 3,
              iconCls : &quot;toolbar-other-load&quot;,
              handler : function() {

                if (me.txtLoadText.validate()) {

                  GLOBAL.APP.MAIN_VIEW.currentState = &quot;&quot;;
                  GLOBAL.APP.SM.oprLoadSharedState(me.txtLoadText.getValue(), cbAfterLoad, me.txtRefName.getValue());
                  me.manageWindow.hide();

                }
              },
              scope : me

            });

        me.btnSaveSharedState = new Ext.Button({

              text : &#39;Create Link&#39;,
              margin : 3,
              iconCls : &quot;toolbar-other-save&quot;,
              handler : function() {

                var oValid = true;

                if (!me.txtLoadText.validate())
                  oValid = false;

                if (!me.txtRefName.validate())
                  oValid = false;

                if (oValid) {

                  GLOBAL.APP.SM.oprSaveSharedState(me.txtRefName.getValue(), me.txtLoadText.getValue(), cbAfterSave);
                  me.manageWindow.hide();

                }

              },
              scope : me

            });

        me.btnLoadAndSaveSharedState = new Ext.Button({

              text : &#39;Load &amp;amp; Create Link&#39;,
              margin : 3,
              iconCls : &quot;toolbar-other-load&quot;,
              handler : function() {
                var oValid = true;

                if (!me.txtLoadText.validate())
                  oValid = false;

                if (!me.txtRefName.validate())
                  oValid = false;

                if (oValid) {

                  GLOBAL.APP.MAIN_VIEW.currentState = &quot;&quot;;
                  GLOBAL.APP.SM.oprLoadSharedState(me.txtLoadText.getValue(), cbAfterLoad, me.txtRefName.getValue());
                  GLOBAL.APP.SM.oprSaveSharedState(me.txtRefName.getValue(), me.txtLoadText.getValue(), cbAfterSave);
                  me.manageWindow.hide();

                }

              },
              scope : me

            });

        var oToolbar = new Ext.toolbar.Toolbar({

              border : false

            });

        oToolbar.add([me.btnLoadSharedState, me.btnSaveSharedState, me.btnLoadAndSaveSharedState]);

        var oPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              autoHeight : true,
              border : false,
              items : [oToolbar, me.txtLoadText, me.txtRefName]
            });

        me.manageWindow = Ext.create(&#39;widget.window&#39;, {
              height : 200,
              width : 500,
              title : &#39;State Loader&#39;,
              layout : &#39;fit&#39;,
              modal : true,
              items : [oPanel],
              iconCls : &quot;system_state_icon&quot;
            });

        me.manageWindow.show();

      },
<span id='Ext-dirac-core-StateManagement-method-formSaveDialog'>      /**
</span>       * It is used when we want to crate a new desktop.
       * 
       * @param {String}
       *          dialogtext the name of the dialog.
       * @param {Function}
       *          cbAfterSave Function that is executed after the save has been
       *          saved
       */
      formSaveDialog : function(sStateType, sAppName, oAppObject, cbAfterSave, dialogtext, save) {

        var me = this;

        me.txtStateName = Ext.create(&#39;Ext.form.field.Text&#39;, {

              fieldLabel : dialogtext,
              labelAlign : &#39;left&#39;,
              margin : 10,
              width : 400,
              enableKeyEvents : true,
              validateValue : function(sValue) {

                sValue = Ext.util.Format.trim(sValue);

                if (sValue.length &lt; 1) {
                  this.markInvalid(&quot;You must specify a name !&quot;);
                  return false;

                } else {

                  if (GLOBAL.APP.SM.isStateLoaded(sStateType, sAppName, sValue) == 1) {

                    this.markInvalid(&quot;The name you enetered already exists !&quot;);
                    return false;

                  } else {

                    if (GLOBAL.APP.SM.isValidStateName(sValue)) {
                      this.clearInvalid();
                      return true;
                    } else {

                      this.markInvalid(&quot;Allowed characters are: 0-9, a-z, A-Z, &#39;_&#39;, &#39;-&#39;, &#39;.&#39;, &#39; &#39;&quot;);
                      return false;

                    }

                  }

                }

              },
              validateOnChange : true,
              validateOnBlur : false,
              listeners : {

                keypress : function(oTextField, e, eOpts) {

                  if (e.getCharCode() == 13) {

                    if (me.txtStateName.isValid()) {

                      var sStateName = me.txtStateName.getValue();

                      if (save) {
                        GLOBAL.APP.SM.oprSendDataForSave(sAppName, oAppObject, sStateType, sStateName, cbAfterSave);
                      } else {
                        cbAfterSave(sStateName);
                      }

                    }

                  }

                }

              }

            });

        // button for saving the state
        me.btnSaveState = new Ext.Button({

              text : &#39;Save&#39;,
              margin : 3,
              iconCls : &quot;dirac-icon-save&quot;,
              handler : function() {

                if (me.txtStateName.isValid()) {

                  var sStateName = me.txtStateName.getValue();

                  if (save) {
                    GLOBAL.APP.SM.oprSendDataForSave(sAppName, oAppObject, sStateType, sStateName, cbAfterSave);
                  } else {
                    cbAfterSave(sStateName);
                  }

                }

              },
              scope : me

            });

        // button to close the save form
        me.btnCancelSaveState = new Ext.Button({

              text : &#39;Cancel&#39;,
              margin : 3,
              iconCls : &quot;toolbar-other-close&quot;,
              handler : function() {

                me.txtStateName.setValue(&quot;&quot;);
                me.saveWindow.hide();

              },
              scope : me

            });

        var oToolbar = new Ext.toolbar.Toolbar({
              border : false
            });

        oToolbar.add([me.btnSaveState, me.btnCancelSaveState]);

        var oPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              autoHeight : true,
              border : false,
              items : [oToolbar, me.txtStateName]
            });

        // initializing window showing the saving form
        me.saveWindow = Ext.create(&#39;widget.window&#39;, {
              height : 120,
              width : 500,
              title : dialogtext,
              layout : &#39;fit&#39;,
              modal : true,
              items : oPanel
            });

        me.saveWindow.show();
        me.txtStateName.focus();

      },
<span id='Ext-dirac-core-StateManagement-method-deleteState'>      deleteState : function(sAppName, stateName, cbFunc) {
</span>
        if (!GLOBAL.APP.SM.isAnyActiveState(sAppName, stateName, cbFunc)) {

          GLOBAL.APP.SM.oprDeleteState(sAppName, &quot;application&quot;, stateName, cbFunc);

        } else {
          GLOBAL.APP.CF.alert(&#39;The state &lt;b&gt;&#39; + stateName + &#39;&lt;/b&gt; you are willing to delete is curently in use !&#39;, &#39;warning&#39;);
        }

      },
<span id='Ext-dirac-core-StateManagement-method-deleteStateFromDesktop'>      deleteStateFromDesktop : function(desktop, appName, stateName, cbAfterSave) {
</span>        var me = this;
        if (!GLOBAL.APP.SM.isAnyActiveState(appName, stateName, cbAfterSave)) {
          var desktops = GLOBAL.APP.SM.getStateData(&quot;application&quot;, &quot;desktop&quot;, desktop);
          for (var i = 0; i &lt; desktops.data.length; i++) {
            if (desktops.data[i].currentState == stateName &amp;&amp; desktops.data[i].module == appName) {
              Ext.Array.erase(desktops.data, i, 1);
              break;
            }
          }
          me.oprSendDataForSave(&quot;desktop&quot;, desktops, &quot;application&quot;, desktop, cbAfterSave);
        } else {
          GLOBAL.APP.CF.alert(&#39;The state &lt;b&gt;&#39; + stateName + &#39;&lt;/b&gt; you are willing to delete is curently in use !&#39;, &#39;warning&#39;);
        }
      },

<span id='Ext-dirac-core-StateManagement-method-oprSendDataForSave'>      oprSendDataForSave : function(sAppName, oSendData, sStateType, sStateName, cbAfterSave) {
</span>        var me = this;
        Ext.Ajax.request({
              url : GLOBAL.BASE_URL + &#39;UP/saveAppState&#39;,
              params : {
                app : sAppName,
                name : sStateName,
                state : Ext.JSON.encode(oSendData),
                obj : sStateType
              },
              scope : me,
              success : function(oResponse) {

                if (oResponse.status == 200) {
                  var me = this;
                  Ext.dirac.system_info.msg(&quot;Notification&quot;, &#39;State saved successfully !&#39;);

                  GLOBAL.APP.SM.cache[sStateType][sAppName][sStateName] = oSendData;

                  cbAfterSave(1, sAppName, sStateType, sStateName);

                } else {

                  GLOBAL.APP.CF.showAjaxErrorMessage(response);

                  if (oResponse.status == 400) {

                    cbAfterSave(-1, sAppName, sStateType, sStateName);

                  } else {

                    cbAfterSave(-2, sAppName, sStateType, sStateName);

                  }
                }

              },
              failure : function(response) {

                GLOBAL.APP.CF.showAjaxErrorMessage(response);

                if (response.status == 400) {
                  cbAfterSave(-3, sAppName, sStateType, sStateName);
                } else {
                  cbAfterSave(-4, sAppName, sStateType, sStateName);
                }
              }
            });
      },
<span id='Ext-dirac-core-StateManagement-method-saveState'>      saveState : function(desktop, app, state, cbFunc) {
</span>        var me = this;
        var desktop = (desktop == &quot;&quot; ? &#39;Default&#39; : desktop);
        var appContainer = GLOBAL.APP.MAIN_VIEW.getRightContainer();
        if (appContainer) {
          var tab = appContainer.getTabFromApplicationContainer(desktop);
          if (tab &amp;&amp; tab.isLoaded) {
            var appTab = tab.getPanel(state);
            if (appTab &amp;&amp; appTab.isLoaded) {
              if (desktop == &#39;Default&#39;) {
                var activeDesktop = GLOBAL.APP.MAIN_VIEW.getActiveDesktop();

                var appl = activeDesktop.getActiveTab();

                var funcAfterSave = function(returnCode, appName, stateType, stateName) {

                  if ((returnCode == 1) &amp;&amp; (appl.currentState != stateName)) {
                    me.__changeActiveState(appl, appName, stateType, stateName);
                  }

                };

                GLOBAL.APP.MAIN_VIEW.SM.oprSaveAppState(&quot;application&quot;, appl.loadedObject.self.getName(), appl.loadedObject, funcAfterSave);
              } else {
                var desktops = GLOBAL.APP.SM.getStateData(&quot;application&quot;, &quot;desktop&quot;, desktop);
                var found = false;
                if (desktops != -1) {
                  for (var i = 0; i &lt; desktops.data.length; i++) {
                    if (desktops.data[i].module == app &amp;&amp; desktops.data[i].currentState == state) {
                      desktops.data[i].data = appTab.loadedObject.getStateData();
                      if (appTab.childWindows.length &gt; 0) {
                        // we have to save the help text automatically.
                        for (var i = 0; i &lt; appTab.childWindows.length; i++) {
                          if (appTab.childWindows[i].type == &quot;help&quot;) {
                            // The Notepad is open. The text has to be retrieved
                            // from the notepad...
                            var helptext = {
                              &quot;helptext&quot; : appTab.childWindows[i].items.getAt(0).getValue()
                            }
                            Ext.apply(desktops.data[i].data, helptext);
                          }
                        }
                      } else {
                        Ext.apply(desktops.data[i].data, appTab.loadedObject.getHelpText());
                      }
                      found = true;
                      break;
                    }
                  }
                }

                if (!found) {

                  me.formSaveStateOfData(desktop, appTab, &quot;application&quot;, app, function(returnCode, sAppName, sStateType, sStateName) {
                        // cbFunc(desktop, app, sStateName);
                        if ((returnCode == 1) &amp;&amp; (appTab.loadedObject.currentState != sStateName)) {

                          GLOBAL.APP.SM.oprRemoveActiveState(sAppName, appTab.loadedObject.currentState);

                          appTab.loadedObject.currentState = sStateName;
                          appTab.currentState = sStateName;
                          GLOBAL.APP.SM.oprAddActiveState(sAppName, sStateName);
                          appTab.setTitle(appTab.loadedObject.launcher.title + &quot; [&quot; + appTab.loadedObject.currentState + &quot;]&quot;);

                          if (GLOBAL.APP.MAIN_VIEW.SM.saveWindow)
                            GLOBAL.APP.MAIN_VIEW.SM.saveWindow.close();
                        }

                        GLOBAL.APP.MAIN_VIEW.addApplicationToDesktopMenu(desktop, sStateName, app);
                      });
                } else {
                  me.oprSendDataForSave(&quot;desktop&quot;, desktops, &quot;application&quot;, desktop, cbFunc);
                }

              }

            } else { // The state is not loaded. We do not have to save...
              Ext.dirac.system_info.msg(&quot;Notification&quot;, state + &#39; is not modified! It is already saved!&#39;);
            }

          } else {// the application state is not loaded...
            var desktops = GLOBAL.APP.SM.getStateData(&quot;application&quot;, &quot;desktop&quot;, desktop);

            for (var i = 0; i &lt; desktops.data.length; i++) {
              if (desktops.data[i].currentState == state &amp;&amp; desktops.data[i].module == app) {
                desktops.data[i] = appTab.loadedObject.getStateData();
                if (appTab.childWindows.length &gt; 0) {
                  // we have to save the help text automatically.
                  for (var i = 0; i &lt; appTab.childWindows.length; i++) {
                    if (appTab.childWindows[i].type == &quot;help&quot;) {
                      // The Notepad is open. The text has to be retrieved
                      // from the notepad...
                      var helptext = {
                        &quot;helptext&quot; : appTab.childWindows[i].items.getAt(0).getValue()
                      }
                      Ext.apply(desktops.data[i].data, helptext);
                    }
                  }
                } else {
                  Ext.apply(desktops.data[i].data, appTab.loadedObject.getHelpText());
                }

                break;
              }
            }

            me.oprSendDataForSave(&quot;desktop&quot;, desktops, &quot;application&quot;, desktop, cbFunc);
          }
        } else {
          cbFunc(desktop, app, state);
        }

      },
<span id='Ext-dirac-core-StateManagement-method-saveAsState'>      saveAsState : function(desktop, app, state, cbFunc) {
</span>        var me = this;
        var desktop = (desktop == &quot;&quot; ? &#39;Default&#39; : desktop);
        var appContainer = GLOBAL.APP.MAIN_VIEW.getRightContainer();
        if (appContainer) {
          var tab = appContainer.getTabFromApplicationContainer(desktop);
          if (tab &amp;&amp; tab.isLoaded) {
            var appTab = tab.getPanel(state);
            if (appTab &amp;&amp; appTab.isLoaded) {
              if (desktop == &#39;Default&#39;) { // we are on the default desktop

                var activeDesktop = GLOBAL.APP.MAIN_VIEW.getActiveDesktop();

                var appl = activeDesktop.getActiveTab();

                var funcAfterSave = function(returnCode, appName, stateType, stateName) {

                  if ((returnCode == 1) &amp;&amp; (appl.currentState != sStateName)) {

                    me.__changeActiveState(appl, appName, stateType, stateName);

                  }
                };

                GLOBAL.APP.MAIN_VIEW.SM.formSaveState(&quot;application&quot;, app, appl.loadedObject, funcAfterSave);

              } else {// we have to add to the menu and we have to save it...
                me.formSaveAsStateOfData(desktop, state, &quot;application&quot;, app, function(iCode, sAppName, sStateType, sStateName) {
                      cbFunc(desktop, app, sStateName);
                      GLOBAL.APP.MAIN_VIEW.addApplicationToDesktopMenu(desktop, sStateName, app);
                    });
              }
            } else {
              me.formSaveAsStateOfData(desktop, state, &quot;application&quot;, app, function(iCode, sAppName, sStateType, sStateName) {
                    cbFunc(desktop, app, sStateName);
                    GLOBAL.APP.MAIN_VIEW.addApplicationToDesktopMenu(desktop, sStateName, app);
                  });
            }
          } else {
            me.formSaveAsStateOfData(desktop, state, &quot;application&quot;, app, function(iCode, sAppName, sStateType, sStateName) {
                  cbFunc(desktop, app, sStateName);
                  GLOBAL.APP.MAIN_VIEW.addApplicationToDesktopMenu(desktop, sStateName, app);
                });
          }
        }
      },
<span id='Ext-dirac-core-StateManagement-method-__changeActiveState'>      __changeActiveState : function(appObj, appName, stateType, stateName) {
</span>        var me = this;
        var oldApplicationUrl = appObj.getUrlDescription();
        GLOBAL.APP.MAIN_VIEW.getRightContainer().addStateToExistingWindows(stateName, appName);

        if (appObj.currentState != &quot;&quot;)
          GLOBAL.APP.SM.oprRemoveActiveState(appName, appObj.currentState);

        appObj.loadedObject.currentState = stateName;
        appObj.currentState = stateName;
        GLOBAL.APP.SM.oprAddActiveState(appName, stateName);
        appObj.setTitle(appObj.loadedObject.launcher.title + &quot; [&quot; + appObj.loadedObject.currentState + &quot;]&quot;);

        if (GLOBAL.APP.MAIN_VIEW.SM.saveWindow)
          GLOBAL.APP.MAIN_VIEW.SM.saveWindow.close();
        Ext.Array.remove(GLOBAL.APP.MAIN_VIEW._default_desktop_state, oldApplicationUrl);

        GLOBAL.APP.MAIN_VIEW.refreshUrlDesktopState();

      },
<span id='Ext-dirac-core-StateManagement-method-formSaveStateOfData'>      /**
</span>       * Function called when the Save... button from the SAVE context menu is
       * clicked
       * 
       * @param {String}
       *          sStateType The type of the state [application|reference]
       * @param {String}
       *          sAppName Application class name
       * @param {Object}
       *          oAppObject The application object
       * @param {Function}
       *          cbAfterSave Function that is executed after the save has been
       *          saved
       */
      formSaveStateOfData : function(desktop, appObj, sStateType, sAppName, cbAfterSave) {

        var me = this;

        me.txtStateName = Ext.create(&#39;Ext.form.field.Text&#39;, {

              fieldLabel : &quot;State Name:&quot;,
              labelAlign : &#39;left&#39;,
              margin : 10,
              width : 400,
              enableKeyEvents : true,
              validateValue : function(sValue) {

                sValue = Ext.util.Format.trim(sValue);

                if (sValue.length &lt; 1) {
                  this.markInvalid(&quot;You must specify a name !&quot;);
                  return false;

                } else {

                  if (GLOBAL.APP.SM.isStateLoaded(sStateType, sAppName, sValue) == 1) {

                    this.markInvalid(&quot;The name you enetered already exists !&quot;);
                    return false;

                  } else {

                    if (GLOBAL.APP.SM.isValidStateName(sValue)) {
                      this.clearInvalid();
                      return true;
                    } else {

                      this.markInvalid(&quot;Allowed characters are: 0-9, a-z, A-Z, &#39;_&#39;, &#39;-&#39;, &#39;.&#39;, &#39; &#39;&quot;);
                      return false;

                    }

                  }

                }

              },
              validateOnChange : true,
              validateOnBlur : false,
              listeners : {

                keypress : function(oTextField, e, eOpts) {

                  if (e.getCharCode() == 13) {

                    if (me.txtStateName.isValid()) {

                      var sStateName = me.txtStateName.getValue();

                      var desktops = GLOBAL.APP.SM.getStateData(&quot;application&quot;, &quot;desktop&quot;, desktop);
                      var data = {
                        data : appObj.loadedObject.getStateData(),
                        module : appObj.loadedObject.self.getName(),
                        currentState : sStateName
                      };
                      if (appObj.childWindows.length &gt; 0) {
                        // we have to save the help text automatically.
                        for (var i = 0; i &lt; appObj.childWindows.length; i++) {
                          if (appObj.childWindows[i].type == &quot;help&quot;) {
                            // The Notepad is open. The text has to be retrieved
                            // from the notepad...
                            var helptext = {
                              &quot;helptext&quot; : appObj.childWindows[i].items.getAt(0).getValue()
                            };
                            Ext.apply(data.data, helptext);
                          }
                        }
                      } else {
                        Ext.apply(data.data, appObj.loadedObject.getHelpText());
                      }

                      desktops.data.push(data);
                      me.oprSendDataForSave(&quot;desktop&quot;, desktops, &quot;application&quot;, desktop, function(iCode, appName, stateType, stateName) {
                            cbAfterSave(iCode, appObj.loadedObject.self.getName(), stateType, sStateName);
                          });

                    }

                  }

                }

              }

            });

        // button for saving the state
        me.btnSaveState = new Ext.Button({

              text : &#39;Save&#39;,
              margin : 3,
              iconCls : &quot;dirac-icon-save&quot;,
              handler : function() {

                if (me.txtStateName.isValid()) {

                  var sStateName = me.txtStateName.getValue();

                  var desktops = GLOBAL.APP.SM.getStateData(&quot;application&quot;, &quot;desktop&quot;, desktop);

                  var data = {
                    data : appObj.loadedObject.getStateData(),
                    module : appObj.loadedObject.self.getName(),
                    currentState : sStateName
                  };

                  if (appObj.childWindows.length &gt; 0) {
                    // we have to save the help text automatically.
                    for (var i = 0; i &lt; appObj.childWindows.length; i++) {
                      if (appObj.childWindows[i].type == &quot;help&quot;) {
                        // The Notepad is open. The text has to be retrieved
                        // from the notepad...
                        var helptext = {
                          &quot;helptext&quot; : appObj.childWindows[i].items.getAt(0).getValue()
                        }
                        Ext.apply(data.data, helptext);
                      }
                    }
                  } else {
                    Ext.apply(data.data, appObj.loadedObject.getHelpText());
                  }

                  desktops.data.push(data);

                  me.oprSendDataForSave(&quot;desktop&quot;, desktops, &quot;application&quot;, desktop, function(iCode, appName, stateType, stateName) {
                        cbAfterSave(iCode, appObj.loadedObject.self.getName(), stateType, sStateName);
                      });

                }

              },
              scope : me

            });

        // button to close the save form
        me.btnCancelSaveState = new Ext.Button({

              text : &#39;Cancel&#39;,
              margin : 3,
              iconCls : &quot;toolbar-other-close&quot;,
              handler : function() {

                me.txtStateName.setValue(&quot;&quot;);
                me.saveWindow.hide();

              },
              scope : me

            });

        var oToolbar = new Ext.toolbar.Toolbar({
              border : false
            });

        oToolbar.add([me.btnSaveState, me.btnCancelSaveState]);

        var oPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              autoHeight : true,
              border : false,
              items : [oToolbar, me.txtStateName]
            });

        // initializing window showing the saving form
        me.saveWindow = Ext.create(&#39;widget.window&#39;, {
              height : 120,
              width : 500,
              title : &#39;Save state&#39;,
              layout : &#39;fit&#39;,
              modal : true,
              items : oPanel
            });

        me.saveWindow.show();
        me.txtStateName.focus();

      },
<span id='Ext-dirac-core-StateManagement-method-moveAppState'>      moveAppState : function(stateName, moduleName, fromDesktopName, toDesktopName) {
</span>        var me = this;
        var data = {};

        if (fromDesktopName == &#39;Default&#39;) {
          Ext.apply(data, {
                data : GLOBAL.APP.SM.getStateData(&quot;application&quot;, moduleName, stateName),
                currentState : stateName,
                module : moduleName,
                loadedObjectType : &quot;app&quot;
              });

          me.addStateToDesktop(toDesktopName, data, function() {
                me.deleteState(moduleName, stateName, function() {
                    });
              });
        } else {
          var fromDsktop = GLOBAL.APP.SM.getStateData(&quot;application&quot;, &quot;desktop&quot;, fromDesktopName);
          if (fromDsktop != -1) {
            for (var i = 0; i &lt; fromDsktop.data.length; i++) {
              if (fromDsktop.data[i].module == moduleName &amp;&amp; fromDsktop.data[i].currentState == stateName) {
                data = fromDsktop.data[i];
                break;
              }
            }
          }
          me.addStateToDesktop(toDesktopName, data, function() {
                me.deleteStateFromDesktop(fromDesktop, moduleName, stateName, function() {
                    });
              });
        }

      },
<span id='Ext-dirac-core-StateManagement-method-addStateToDesktop'>      addStateToDesktop : function(desktopName, data, cbAfterSave) {
</span>        var me = this;

        if (desktopName == &#39;Default&#39;) {
          GLOBAL.APP.SM.oprSendDataForSave(&quot;application&quot;, data.data, data.module, data.currentState, cbAfterSave);
        } else {
          var desktops = GLOBAL.APP.SM.getStateData(&quot;application&quot;, &quot;desktop&quot;, desktopName);
          desktops.data.push(data);
          me.oprSendDataForSave(&quot;desktop&quot;, desktops, &quot;application&quot;, desktopName, cbAfterSave);
        }

      }

    });
</pre>
</body>
</html>
