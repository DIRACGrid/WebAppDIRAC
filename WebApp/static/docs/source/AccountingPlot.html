<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define(&#39;DIRAC.AccountingPlot.classes.AccountingPlot&#39;, {
      extend : &#39;Ext.dirac.core.Module&#39;,
      requires : [&#39;Ext.util.*&#39;, &#39;Ext.panel.Panel&#39;, &quot;Ext.form.field.Text&quot;, &quot;Ext.button.Button&quot;, &quot;Ext.menu.Menu&quot;, &quot;Ext.form.field.ComboBox&quot;, &quot;Ext.layout.*&quot;, &quot;Ext.form.field.Date&quot;, &quot;Ext.form.field.TextArea&quot;, &quot;Ext.form.field.Checkbox&quot;, &quot;Ext.form.FieldSet&quot;, &quot;Ext.Button&quot;,
          &quot;Ext.dirac.utils.DiracMultiSelect&quot;, &quot;Ext.util.*&quot;, &quot;Ext.toolbar.Toolbar&quot;, &quot;Ext.data.Record&quot;],

      loadState : function(oData) {

        var me = this;
        me.__stretchPlotMode = (oData.__stretchPlotMode == 1);

        me.btnRefreshMenu.timeSpan = parseInt(oData.__auto_refresh_time, 10);

        switch (me.btnRefreshMenu.timeSpan) {

          case 0 :
            me.btnRefreshMenu.setText(&quot;Auto refresh : Disabled&quot;);
            break;
          case 900000 :
            me.btnRefreshMenu.setText(&quot;Auto refresh : Each 15m&quot;);
            break;
          case 3600000 :
            me.btnRefreshMenu.setText(&quot;Auto refresh : Each hour&quot;);
            break;
          case 86400000 :
            me.btnRefreshMenu.setText(&quot;Auto refresh : Each day&quot;);
            break;

        }

        me.__loadSelectionData(oData.plotParams);

        if (me.btnRefreshMenu.timeSpan != 0) {

          clearInterval(me.rightPanel.refreshTimeout);
          me.rightPanel.refreshTimeout = setInterval(function() {

                Ext.Ajax.request({
                      url : GLOBAL.BASE_URL + &#39;AccountingPlot/generatePlot&#39;,
                      params : me.plotParams,
                      success : function(responseImg) {

                        responseImg = Ext.JSON.decode(responseImg.responseText);

                        if (responseImg[&quot;success&quot;]) {

                          me.plotImage.setSrc(GLOBAL.BASE_URL + &quot;AccountingPlot/getPlotImg?file=&quot; + responseImg[&quot;data&quot;] + &quot;&amp;nocache=&quot; + (new Date()).getTime());
                          me.rightPanel.setLoading(&#39;Loading Image ...&#39;);

                        }
                      }
                    });

              }, me.btnRefreshMenu.timeSpan);

        }

      },

      /*
       * PARTLY DONE
       */
      getStateData : function() {

        var me = this;
        var oReturn = {};

        oReturn.plotParams = me.__getSelectionParametars(&quot;save_state&quot;);
        oReturn.__stretchPlotMode = ((me.__stretchPlotMode) ? 1 : 0);
        oReturn.__auto_refresh_time = me.btnRefreshMenu.timeSpan;

        return oReturn;

      },

      initComponent : function() {
        var me = this;

        if (GLOBAL.VIEW_ID == &quot;desktop&quot;) {

          me.launcher.title = &quot;Accounting&quot;;
          me.launcher.maximized = false;

          var oDimensions = GLOBAL.APP.MAIN_VIEW.getViewMainDimensions();
          var iDim = Math.floor(Math.min(oDimensions[0], oDimensions[1]) / 2);
          me.launcher.width = 2 * iDim;
          me.launcher.height = iDim;

          me.launcher.x = 0;
          me.launcher.y = 0;

        }

        if (GLOBAL.VIEW_ID == &quot;tabs&quot;) {

          me.launcher.title = &quot;Accounting&quot;;
          me.launcher.maximized = false;

          var oDimensions = GLOBAL.APP.MAIN_VIEW.getViewMainDimensions();
          var iDim = Math.floor(Math.min(oDimensions[0], oDimensions[1]) / 2);
          me.launcher.width = 2 * iDim;
          me.launcher.height = iDim;

          me.launcher.x = 0;
          me.launcher.y = 0;

        }

        Ext.apply(me, {
              layout : &#39;border&#39;,
              bodyBorder : false,
              defaults : {
                collapsible : true,
                split : true
              }
            });

        me.callParent(arguments);

      },

      buildUI : function() {

        var me = this;

        /*
         * -----------------------------------------------------------------------------------------------------------
         * DEFINITION OF THE LEFT PANEL
         * -----------------------------------------------------------------------------------------------------------
         */

        me.leftPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              region : &quot;west&quot;,
              floatable : false,
              header : false,
              margins : &#39;0&#39;,
              width : 350,
              minWidth : 330,
              maxWidth : 450,
              bodyPadding : 5,
              layout : &#39;anchor&#39;,
              autoScroll : true
            });

        me.rightPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              region : &quot;center&quot;,
              floatable : false,
              header : false,
              margins : &#39;0&#39;,
              bodyPadding : 0,
              layout : &quot;border&quot;
            });

        me.descPlotType = {
          DataOperation : {
            title : &quot;Data Operation&quot;,
            selectionConditions : [[&quot;OperationType&quot;, &quot;Operation Type&quot;], [&quot;User&quot;, &quot;User&quot;], [&quot;ExecutionSite&quot;, &quot;Execution Site&quot;], [&quot;Source&quot;, &quot;Source Site&quot;], [&quot;Destination&quot;, &quot;Destination Site&quot;], [&quot;Protocol&quot;, &quot;Protocol&quot;], [&quot;FinalStatus&quot;, &quot;Final Transfer Status&quot;]]

          },
          Job : {
            title : &quot;Job&quot;,
            selectionConditions : [[&quot;JobGroup&quot;, &quot;Job Group&quot;], [&quot;JobType&quot;, &quot;Job Type&quot;], [&quot;JobClass&quot;, &quot;Job Class&quot;], [&quot;Site&quot;, &quot;Site&quot;], [&quot;ProcessingType&quot;, &quot;Processing Type&quot;], [&quot;FinalMajorStatus&quot;, &quot;Final Major Status&quot;], [&quot;FinalMinorStatus&quot;, &quot;Final Minor Status&quot;], [&quot;User&quot;, &quot;User&quot;],
                [&quot;UserGroup&quot;, &quot;User Group&quot;]]

          },
          WMSHistory : {
            title : &quot;WMS History&quot;,
            selectionConditions : [[&quot;User&quot;, &quot;User&quot;], [&quot;UserGroup&quot;, &quot;User Group&quot;], [&quot;Status&quot;, &quot;Major Status&quot;], [&quot;MinorStatus&quot;, &quot;Minor Status&quot;], [&quot;ApplicationStatus&quot;, &quot;Application Status&quot;], [&quot;Site&quot;, &quot;Site&quot;], [&quot;JobGroup&quot;, &quot;Job Group&quot;], [&quot;JobSplitType&quot;, &quot;Job Split Type&quot;]]

          },
          Pilot : {
            title : &quot;Pilot&quot;,
            selectionConditions : [[&quot;User&quot;, &quot;User&quot;], [&quot;UserGroup&quot;, &quot;User Group&quot;], [&quot;Site&quot;, &quot;Site&quot;], [&quot;GridCE&quot;, &quot;Grid CE&quot;], [&quot;GridMiddleware&quot;, &quot;Grid Middleware&quot;], [&quot;GridResourceBroker&quot;, &quot;Grid Resource Broker&quot;], [&quot;GridStatus&quot;, &quot;Grid Status&quot;]]

          },
          SRMSpaceTokenDeployment : {
            title : &quot;SRM Space Token Deployment&quot;,
            selectionConditions : [[&quot;Site&quot;, &quot;Site&quot;], [&quot;Hostname&quot;, &quot;Hostname&quot;], [&quot;SpaceTokenDesc&quot;, &quot;Space Token Description&quot;]]

          }

        };

        me.cmbDomain = Ext.create(&#39;Ext.form.field.ComboBox&#39;, {
              fieldLabel : &quot;Category&quot;,
              queryMode : &#39;local&#39;,
              labelAlign : &#39;top&#39;,
              displayField : &quot;text&quot;,
              valueField : &quot;value&quot;,
              anchor : &#39;100%&#39;,
              store : new Ext.data.ArrayStore({
                    fields : [&#39;value&#39;, &#39;text&#39;],
                    data : [[&quot;DataOperation&quot;, &quot;Data Operation&quot;], [&quot;Job&quot;, &quot;Job&quot;], [&quot;WMSHistory&quot;, &quot;WMS History&quot;], [&quot;Pilot&quot;, &quot;Pilot&quot;], [&quot;SRMSpaceTokenDeployment&quot;, &quot;SRM Space Token Deployment&quot;]]
                  }),
              listeners : {
                change : function(field, newValue, oldValue, eOpts) {

                  if (newValue == null)
                    return;

                  me.leftPanel.body.mask(&quot;Wait ...&quot;);
                  Ext.Ajax.request({
                        url : GLOBAL.BASE_URL + &#39;AccountingPlot/getSelectionData&#39;,
                        method : &#39;POST&#39;,
                        params : {
                          type : newValue
                        },
                        scope : me,
                        success : function(response) {

                          var oResult = Ext.JSON.decode(response.responseText);

                          if (oResult[&quot;success&quot;] == &quot;true&quot;)
                            me.applyDataToSelection(oResult, newValue);
                          else
                            GLOBAL.APP.CF.alert(oResult[&quot;error&quot;], &quot;error&quot;);
                          me.leftPanel.body.unmask();
                        }
                      });

                }
              }
            });

        me.cmbPlotGenerate = Ext.create(&#39;Ext.form.field.ComboBox&#39;, {
              fieldLabel : &quot;Plot To Generate&quot;,
              queryMode : &#39;local&#39;,
              labelAlign : &#39;top&#39;,
              displayField : &quot;text&quot;,
              valueField : &quot;value&quot;,
              anchor : &#39;100%&#39;
            });

        me.cmbGroupBy = Ext.create(&#39;Ext.form.field.ComboBox&#39;, {
              fieldLabel : &quot;Group By&quot;,
              queryMode : &#39;local&#39;,
              labelAlign : &#39;top&#39;,
              displayField : &quot;text&quot;,
              valueField : &quot;value&quot;,
              anchor : &#39;100%&#39;
            });

        me.fsetTimeSpan = Ext.create(&#39;Ext.form.FieldSet&#39;, {
              title : &#39;Time Span&#39;,
              collapsible : true,
              layout : &#39;anchor&#39;
            });

        me.cmbTimeSpan = Ext.create(&#39;Ext.form.field.ComboBox&#39;, {
              queryMode : &#39;local&#39;,
              displayField : &quot;text&quot;,
              valueField : &quot;value&quot;,
              anchor : &#39;100%&#39;,
              value : 86400,
              store : new Ext.data.ArrayStore({
                    fields : [&#39;value&#39;, &#39;text&#39;],
                    data : [[86400, &quot;Last Day&quot;], [604800, &quot;Last Week&quot;], [2592000, &quot;Last Month&quot;], [-1, &quot;Manual Selection&quot;], [-2, &quot;By Quarter&quot;]]
                  }),
              listeners : {
                change : function(field, newValue, oldValue, eOpts) {

                  me.calendarFrom.hide();
                  me.calendarTo.hide();
                  me.cmbQuarter.hide();

                  switch (newValue) {

                    case -1 :
                      me.calendarFrom.show();
                      me.calendarTo.show();
                      break;
                    case -2 :
                      me.__fillComboQuarter();
                      me.cmbQuarter.show();
                      break;

                  }

                }
              }

            });

        me.calendarFrom = new Ext.create(&#39;Ext.form.field.Date&#39;, {
              width : 100,
              format : &#39;Y-m-d&#39;,
              fieldLabel : &quot;Initial Date&quot;,
              labelAlign : &#39;top&#39;,
              hidden : true
            });

        me.calendarTo = new Ext.create(&#39;Ext.form.field.Date&#39;, {

              width : 100,
              format : &#39;Y-m-d&#39;,
              fieldLabel : &quot;End Date&quot;,
              labelAlign : &#39;top&#39;,
              hidden : true

            });

        me.cmbQuarter = Ext.create(&#39;Ext.dirac.utils.DiracBoxSelect&#39;, {
              fieldLabel : &quot;&quot;,
              displayField : &quot;text&quot;,
              valueField : &quot;value&quot;,
              anchor : &#39;100%&#39;,
              hidden : true
            });

        me.fsetTimeSpan.add([me.cmbTimeSpan, me.calendarFrom, me.calendarTo, me.cmbQuarter]);

        me.fsetSpecialConditions = Ext.create(&#39;Ext.form.FieldSet&#39;, {
              title : &#39;Selection Conditions&#39;,
              collapsible : true,
              layout : &#39;anchor&#39;
            });

        me.fsetAdvanced = Ext.create(&#39;Ext.form.FieldSet&#39;, {
              title : &#39;Advanced Options&#39;,
              collapsible : true,
              layout : &#39;anchor&#39;
            });

        me.advancedPlotTitle = Ext.create(&#39;Ext.form.field.Text&#39;, {

              fieldLabel : &quot;Plot Title&quot;,
              labelAlign : &#39;top&#39;,
              anchor : &quot;100%&quot;
            });

        me.advancedPin = Ext.create(&#39;Ext.form.field.Checkbox&#39;, {
              boxLabel : &#39;Pin Dates&#39;
            });

        me.advancedNotScaleUnits = Ext.create(&#39;Ext.form.field.Checkbox&#39;, {
              boxLabel : &#39;Do not scale units&#39;
            });

        me.fsetAdvanced.add([me.advancedPlotTitle, me.advancedPin, me.advancedNotScaleUnits]);

        me.leftPanel.add([me.cmbDomain, me.cmbPlotGenerate, me.cmbGroupBy, me.fsetTimeSpan, me.fsetSpecialConditions, me.fsetAdvanced]);

        me.btnPlot = new Ext.Button({

              text : &#39;New&#39;,
              margin : 3,
              iconCls : &quot;accp-img-new-plot&quot;,
              handler : function() {

                if (GLOBAL.VIEW_ID = &quot;desktop&quot;) {
                  var oSetupData = {};

                  oSetupData.x = me.getContainer().x + 10;
                  oSetupData.y = me.getContainer().y + 10;
                  oSetupData.width = me.getContainer().getWidth();
                  oSetupData.height = me.getContainer().getHeight();
                  oSetupData.currentState = &quot;&quot;;

                  oSetupData.desktopStickMode = 0;
                  oSetupData.hiddenHeader = 1;
                  oSetupData.i_x = 0;
                  oSetupData.i_y = 0;
                  oSetupData.ic_x = 0;
                  oSetupData.ic_y = 0;

                  oSetupData.data = {
                    plotParams : me.__getSelectionParametars(&quot;save_state&quot;),
                    __stretchPlotMode : (me.__stretchPlotMode ? 1 : 0),
                    __auto_refresh_time : me.btnRefreshMenu.timeSpan
                  };

                  GLOBAL.APP.MAIN_VIEW.createNewModuleContainer({
                        objectType : &quot;app&quot;,
                        moduleName : &quot;DIRAC.AccountingPlot.classes.AccountingPlot&quot;,
                        setupData : oSetupData
                      });
                }

              },
              scope : me

            });

        me.btnReset = new Ext.Button({

              text : &#39;Reset&#39;,
              margin : 3,
              iconCls : &quot;dirac-icon-reset&quot;,
              handler : function() {
                me.__resetSelectionWindow();
              },
              scope : me

            });

        me.btnRefresh = new Ext.Button({

              text : &#39;Refresh&#39;,
              margin : 3,
              iconCls : &quot;dirac-icon-refresh&quot;,
              handler : function() {

                me.leftPanel.body.mask(&quot;Wait ...&quot;);
                Ext.Ajax.request({
                      url : GLOBAL.BASE_URL + &#39;AccountingPlot/getSelectionData&#39;,
                      method : &#39;POST&#39;,
                      params : {
                        type : me.cmbDomain.getValue()
                      },
                      scope : me,
                      success : function(response) {

                        var oResult = Ext.JSON.decode(response.responseText);

                        if (oResult[&quot;success&quot;] == &quot;true&quot;)
                          me.applySpecialConditions(oResult);
                        else
                          GLOBAL.APP.CF.alert(oResult[&quot;error&quot;], &quot;error&quot;);
                        me.leftPanel.body.unmask();
                      }
                    });

              },
              scope : me

            });

        /*
         * This button is used to refresh any previously selected plot that is
         * already generated.
         */
        me.btnRefreshPlot = new Ext.Button({

              text : &#39;Plot&#39;,
              margin : 3,
              iconCls : &quot;dirac-icon-submit&quot;,
              handler : function() {
                me.__generatePlot();
              },
              scope : me

            });

        var oPanelButtons = new Ext.create(&#39;Ext.toolbar.Toolbar&#39;, {
              items : [me.btnRefreshPlot, me.btnPlot, me.btnReset, me.btnRefresh],
              dock : &#39;bottom&#39;,
              layout : {
                pack : &#39;center&#39;
              }
            });

        me.leftPanel.addDocked(oPanelButtons);

        /*
         * -----------------------------------------------------------------------------------------------------------
         * DEFINITION OF THE MAIN CONTAINER
         * -----------------------------------------------------------------------------------------------------------
         */
        me.plotParams = {};
        me.add([me.leftPanel, me.rightPanel]);
        me.plotImage = null;
        me.rightPanel.onResize = function(width, height, oldWidth, oldHeight) {

          me.__oprResizeImageAccordingToContainer();

        };

        me.btnStretchPlot = new Ext.Button({

              text : &#39;Proportional&#39;,
              iconCls : &quot;dirac-icon-proportional&quot;,
              handler : function() {

                me.__stretchPlotMode = !me.__stretchPlotMode;
                me.__oprResizeImageAccordingToContainer();
                if (me.__stretchPlotMode) {

                  me.btnStretchPlot.setText(&quot;Proportional&quot;);
                  me.btnStretchPlot.setIconCls(&quot;dirac-icon-proportional&quot;);

                } else {

                  me.btnStretchPlot.setText(&quot;Stretch&quot;);
                  me.btnStretchPlot.setIconCls(&quot;dirac-icon-stretch&quot;);

                }
              },
              scope : me

            });

        me.refreshMenu = new Ext.menu.Menu({
              items : [{
                    text : &#39;Disabled&#39;,
                    value : 0
                  }, {
                    text : &#39;Each 15m&#39;,
                    value : 900000
                  }, {
                    text : &#39;Each hour&#39;,
                    value : 3600000
                  }, {
                    text : &#39;Each day&#39;,
                    value : 86400000
                  }],
              listeners : {
                click : function(menu, menuItem, e, eOpts) {

                  if (menuItem.value == 0) {
                    clearInterval(me.rightPanel.refreshTimeout);
                  } else {
                    clearInterval(me.rightPanel.refreshTimeout);
                    me.rightPanel.refreshTimeout = setInterval(function() {

                          Ext.Ajax.request({
                                url : GLOBAL.BASE_URL + &#39;AccountingPlot/generatePlot&#39;,
                                params : me.plotParams,
                                success : function(responseImg) {

                                  responseImg = Ext.JSON.decode(responseImg.responseText);

                                  if (responseImg[&quot;success&quot;]) {

                                    me.plotImage.setSrc(GLOBAL.BASE_URL + &quot;AccountingPlot/getPlotImg?file=&quot; + responseImg[&quot;data&quot;] + &quot;&amp;nocache=&quot; + (new Date()).getTime());
                                    me.rightPanel.setLoading(&#39;Loading Image ...&#39;);

                                  }
                                }
                              });

                        }, menuItem.value);
                  }

                  menuItem.parentMenu.up(&#39;button&#39;).setText(&quot;Auto refresh : &quot; + menuItem.text);
                  menuItem.parentMenu.up(&#39;button&#39;).timeSpan = menuItem.value;
                }
              }
            });

        me.btnRefreshMenu = new Ext.Button({

              menu : me.refreshMenu,
              text : &quot;Auto refresh :  Disabled&quot;,
              timeSpan : 0,
              iconCls : &quot;dirac-icon-refresh&quot;

            });

        me.__additionalDataLoad = null;
        me.__stretchPlotMode = true;

      },

      /*
       * OK
       */
      __fillComboQuarter : function() {

        var me = this;

        var oStore = me.cmbQuarter.getStore();
        oStore.removeAll();

        var now = new Date();

        var currentQ = Math.floor(now.getUTCMonth() / 3) + 1;
        var currentYear = now.getUTCFullYear();

        var oRecords = [];

        do {
          var recLabel = &quot;&quot; + currentYear + &quot; Q&quot; + currentQ;
          var recValue = currentYear * 10 + currentQ;

          oRecords.push([recValue, recLabel]);

          currentQ = currentQ - 1;

          if (currentQ == 0) {
            currentQ = 4;
            currentYear = currentYear - 1;
          }

        } while (oRecords.length &lt; 8);

        var oNewStore = new Ext.data.ArrayStore({
              fields : [&#39;value&#39;, &#39;text&#39;],
              data : oRecords
            });

        me.cmbQuarter.bindStore(oNewStore);

      },

      /*
       * OK
       */
      __resetSelectionWindow : function() {

        var me = this;

        me.cmbGroupBy.setValue(null);
        me.cmbPlotGenerate.setValue(null);
        me.calendarFrom.setValue(null);
        me.calendarTo.setValue(null);
        me.cmbTimeSpan.setValue(86400);

        me.advancedPin.setValue(false);
        me.advancedNotScaleUnits.setValue(false);
        me.advancedPlotTitle.setValue(&quot;&quot;);
        me.fsetSpecialConditions.removeAll();
        me.cmbDomain.setValue(null);

      },

      applyDataToSelection : function(oData, sValue) {

        var me = this;

        var oList = oData[&quot;result&quot;][&quot;plotsList&quot;];

        me.__oprDoubleElementItemList(oList);

        var oStore = new Ext.data.ArrayStore({
              fields : [&#39;value&#39;, &#39;text&#39;],
              data : oList
            });

        me.cmbPlotGenerate.setValue(null);

        me.cmbPlotGenerate.bindStore(oStore);

        var oSelectionData = oData[&quot;result&quot;][&quot;selectionValues&quot;];

        var oSelectionOptions = me.descPlotType[sValue][&quot;selectionConditions&quot;];

        me.fsetSpecialConditions.removeAll();

        var oListForGroup = [];

        for (var i = 0; i &lt; oSelectionOptions.length; i++) {

          oListForGroup.push([oSelectionOptions[i][0], oSelectionOptions[i][0]]);

          if ((oSelectionOptions[i][0] == &quot;User&quot;) || (oSelectionOptions[i][0] == &quot;UserGroup&quot;)) {
            var allowedProperties = [&quot;CSAdministrator&quot;, &quot;JobAdministrator&quot;, &quot;JobMonitor&quot;, &quot;UserManager&quot;, &quot;Operator&quot;, &quot;ProductionManagement&quot;];
            var found = false;
            for (var j = 0; j &lt; allowedProperties.length; j++) { // Only
              // powerfull
              // users can
              // choose the
              // User and
              // UserGroup
              if (Ext.Array.indexOf(GLOBAL.USER_CREDENTIALS.properties, allowedProperties[j]) != -1) {
                found = true;
                break;
              }
            }
            if (!found) {
              continue;
            }

          }

          var oList = oSelectionData[oSelectionOptions[i][0]];

          me.__oprDoubleElementItemList(oList);

          var oMultiList = Ext.create(&#39;Ext.dirac.utils.DiracBoxSelect&#39;, {
                fieldLabel : oSelectionOptions[i][1],
                displayField : &quot;text&quot;,
                valueField : &quot;value&quot;,
                anchor : &#39;100%&#39;,
                store : new Ext.data.ArrayStore({
                      fields : [&#39;value&#39;, &#39;text&#39;],
                      data : oList
                    }),
                labelAlign : &#39;top&#39;,
                name : oSelectionOptions[i][0],
                queryMode : &quot;local&quot;
              });

          me.fsetSpecialConditions.add(oMultiList);

        }

        if (sValue == &#39;DataOperation&#39;) {
          // It has to added afterward as we can not select it from
          // the selection condition.
          oListForGroup.push([&#39;Channel&#39;, &#39;Channel&#39;]);
        }

        if (sValue == &#39;Job&#39;) {
          oListForGroup.push([&#39;Country&#39;, &#39;Country&#39;]);
          oListForGroup.push([&#39;Grid&#39;, &#39;Grid&#39;]);
        }

        var oStore = new Ext.data.ArrayStore({
              fields : [&#39;value&#39;, &#39;text&#39;],
              data : oListForGroup
            });

        me.cmbGroupBy.setValue(null);

        me.cmbGroupBy.bindStore(oStore);

        // we call the additional function
        if (me.__additionalDataLoad != null) {
          me.__additionalDataLoad();
          me.__additionalDataLoad = null;
        } else {
          me.advancedPlotTitle.setValue(&quot;&quot;);
        }

      },

      /*
       * OK
       */
      applySpecialConditions : function(oData) {

        var me = this;

        var oSelectionData = oData[&quot;result&quot;][&quot;selectionValues&quot;];

        for (var i = 0; i &lt; me.fsetSpecialConditions.items.length; i++) {

          var oBox = me.fsetSpecialConditions.items.getAt(i);

          var oList = oSelectionData[oBox.getName()];
          me.__oprDoubleElementItemList(oList);

          oBox.loadData(oList);

        }

      },
      /*
       * OK
       */
      __oprDoubleElementItemList : function(oList) {

        for (var i = 0; i &lt; oList.length; i++)
          oList[i] = [oList[i], oList[i]];

      },

      /*
       * OK
       */
      __validateConditions : function(bWithMessages) {

        var me = this;
        var bValid = true;

        // check if the plot type is chosen
        if ((me.cmbDomain.getValue() == null) || (Ext.util.Format.trim(me.cmbDomain.getValue()) == &quot;&quot;)) {

          if (bWithMessages)
            GLOBAL.APP.CF.alert(&quot;No category defined !&quot;, &quot;warning&quot;);

          bValid = false;

        } else if ((me.cmbPlotGenerate.getValue() == null) || (Ext.util.Format.trim(me.cmbPlotGenerate.getValue()) == &quot;&quot;)) {

          if (bWithMessages)
            GLOBAL.APP.CF.alert(&quot;No plot type defined !&quot;, &quot;warning&quot;);

          bValid = false;

        } else if ((me.cmbGroupBy.getValue() == null) || (Ext.util.Format.trim(me.cmbGroupBy.getValue()) == &quot;&quot;)) {

          if (bWithMessages)
            GLOBAL.APP.CF.alert(&quot;No data grouping defined !&quot;, &quot;warning&quot;);

          bValid = false;

        }

        // checking the time span selection

        switch (me.cmbTimeSpan.getValue()) {

          case -1 :
            if (me.calendarFrom.getValue() == null) {

              if (bWithMessages)
                GLOBAL.APP.CF.alert(&quot;No start date selected !&quot;, &quot;warning&quot;);

              bValid = false;

            }

            if ((me.calendarFrom.getValue() != null) &amp;&amp; (me.calendarTo.getValue() != null)) {

              if (me.calendarFrom.getValue() &gt; me.calendarTo.getValue()) {

                if (bWithMessages)
                  GLOBAL.APP.CF.alert(&quot;Selected dates are not valid !&quot;, &quot;warning&quot;);

                bValid = false;

              }

            }
            break;
          case -2 :
            if (me.cmbQuarter.getValue().length == 0) {

              if (bWithMessages)
                GLOBAL.APP.CF.alert(&quot;No quarters selected !&quot;, &quot;warning&quot;);

              bValid = false;

            }
            break;

        }

        return bValid;

      },

      /*
       * OK
       */
      __getSelectionParametars : function(sIntention) {

        var me = this;

        var sDomain = me.cmbDomain.getValue();

        var oParams = {

          _grouping : me.cmbGroupBy.getValue(),
          _plotName : me.cmbPlotGenerate.getValue(),
          _typeName : sDomain

        };

        var fixTime = function(st) {
          var year = st.getFullYear().toString();
          var month = st.getMonth() + 1;
          month = (month &lt; 10 ? &quot;0&quot; : &quot;&quot;) + month;
          var day = st.getDate();
          day = (day &lt; 10 ? &quot;0&quot; : &quot;&quot;) + day;
          return year + &quot;-&quot; + month + &quot;-&quot; + day;
        };

        // Time Selector

        iTimeSpan = me.cmbTimeSpan.getValue();

        if (iTimeSpan == -1) {

          oParams._timeSelector = -1;

          oParams._startTime = fixTime(me.calendarFrom.getValue());

          if (me.calendarTo.getValue() != null)
            oParams._endTime = fixTime(me.calendarTo.getValue());

        } else if (iTimeSpan == -2) {

          oParams._timeSelector = -2;

          var oSelectedQuarters = me.cmbQuarter.getValue();
          var oMinQuarter = Ext.Array.min(oSelectedQuarters);
          var oMaxQuarter = Ext.Array.max(oSelectedQuarters);

          var oMinDate = null;

          var oYear = Math.floor(oMinQuarter / 10);
          var oMonth = ((oMinQuarter % 10) - 1) * 3 + 1;

          oParams._startTime = oYear.toString() + &quot;-&quot; + ((oMonth &lt; 10) ? &quot;0&quot; : &quot;&quot;) + oMonth.toString() + &quot;-01&quot;;

          var oMaxDate = null;

          var oYear = Math.floor(oMaxQuarter / 10);
          var oMonth = (oMaxQuarter % 10) * 3;
          var oDay = ((oMonth == 6) ? 30 : 31);

          oParams._endTime = oYear.toString() + &quot;-&quot; + ((oMonth &lt; 10) ? &quot;0&quot; : &quot;&quot;) + oMonth.toString() + &quot;-&quot; + oDay.toString();

          var oRawSelection = me.cmbQuarter.getRawValue().split(&quot;,&quot;);
          var oQuarters = [];

          for (var i = 0; i &lt; oRawSelection.length; i++)
            oQuarters.push(Ext.util.Format.trim(oRawSelection[i]));

          oParams._quarters = oQuarters;

        } else {

          oParams._timeSelector = iTimeSpan;

        }

        // Special condition selection
        for (var i = 0; i &lt; me.fsetSpecialConditions.items.length; i++) {

          var oCondItem = me.fsetSpecialConditions.items.getAt(i);
          if (oCondItem.getValue().length != 0) {

            if (sIntention == &quot;show_plot&quot;) {
              oParams[&quot;_&quot; + oCondItem.getName()] = ((oCondItem.isInverseSelection()) ? oCondItem.getInverseSelection() : oCondItem.getValue().join(&quot;,&quot;));
            } else if (sIntention == &quot;save_state&quot;) {
              oParams[&quot;_&quot; + oCondItem.getName()] = [((oCondItem.isInverseSelection()) ? 1 : 0), oCondItem.getValue().join(&quot;,&quot;)];
            }
          }

        }

        if (Ext.util.Format.trim(me.advancedPlotTitle.getValue()) != &quot;&quot;) {
          oParams[&quot;_plotTitle&quot;] = me.advancedPlotTitle.getValue();
          sTitle = me.advancedPlotTitle.getValue();
        }

        if (me.advancedPin.checked) {

          oParams[&quot;_pinDates&quot;] = &quot;true&quot;;

        }

        if (me.advancedNotScaleUnits.checked) {

          oParams[&quot;_ex_staticUnits&quot;] = &quot;true&quot;;

        }

        return oParams;

      },
      /*
       * OK
       */
      __oprResizeImageAccordingToContainer : function() {

        var me = this;

        if (me.plotImage == null)
          return;

        if (me.__stretchPlotMode) {
          me.plotImage.setWidth(me.rightPanel.getWidth() - 10);
          me.plotImage.setHeight(me.rightPanel.getHeight() - me.plotToolbar.getHeight() - 10);
          me.btnStretchPlot.setText(&quot;Proportional&quot;);
          me.btnStretchPlot.setIconCls(&quot;dirac-icon-proportional&quot;);
          return;
        } else {
          me.btnStretchPlot.setText(&quot;Stretch&quot;);
          me.btnStretchPlot.setIconCls(&quot;dirac-icon-stretch&quot;);
        }

        var a = me.plotImage.originalWidth;
        var b = me.plotImage.originalHeight;

        var a1 = me.rightPanel.getWidth() - 10;
        var b1 = me.rightPanel.getHeight() - me.plotToolbar.getHeight() - 10;

        if (a1 &lt; 0)
          a1 = 0;
        if (b1 &lt; 0)
          b1 = 0;

        if (b &lt;= b1) {

          if (a &lt;= a1) {

            if ((a1 / a) &lt;= (b1 / b)) {

              me.plotImage.setWidth(a1);
              me.plotImage.setHeight(parseInt(a1 / a * b));

            } else {

              me.plotImage.setHeight(b1);
              me.plotImage.setWidth(parseInt(b1 / b * a));

            }

          } else {

            me.plotImage.setWidth(a1);
            me.plotImage.setHeight(parseInt(a1 / a * b));

          }

        } else {

          if (a &lt;= a1) {

            me.plotImage.setHeight(b1);
            me.plotImage.setWidth(parseInt(b1 / b * a));

          } else {

            if ((a1 / a) &lt;= (b1 / b)) {

              me.plotImage.setWidth(a1);
              me.plotImage.setHeight(parseInt(a1 / a * b));

            } else {

              me.plotImage.setHeight(b1);
              me.plotImage.setWidth(parseInt(b1 / b * a));

            }

          }

        }

      },

      __generatePlot : function() {

        var me = this;

        if (!me.__validateConditions(true))
          return;

        me.plotParams = me.__getSelectionParametars(&quot;show_plot&quot;);
        me.plotParamsForSaveState = me.__getSelectionParametars(&quot;save_state&quot;);

        Ext.Ajax.request({
              url : GLOBAL.BASE_URL + &#39;AccountingPlot/generatePlot&#39;,
              params : me.plotParams,
              scope : me,
              success : function(response) {

                var me = this;
                var response = Ext.JSON.decode(response.responseText);

                if (response[&quot;success&quot;]) {

                  /*
                   * This should go into the container, where we have to load
                   * the image
                   */
                  me.leftPanel.collapse();
                  me.plotImage = Ext.create(&#39;Ext.Img&#39;, {
                        region : &quot;center&quot;,
                        src : GLOBAL.BASE_URL + &quot;AccountingPlot/getPlotImg?file=&quot; + response[&quot;data&quot;] + &quot;&amp;nocache=&quot; + (new Date()).getTime(),
                        listeners : {

                          render : function(oElem, eOpts) {
                            oElem.el.on({
                                  load : function(evt, ele, opts) {

                                    oElem.originalWidth = oElem.getWidth();
                                    oElem.originalHeight = oElem.getHeight();

                                    me.__oprResizeImageAccordingToContainer();

                                    me.rightPanel.setLoading(false);

                                  }
                                });

                          }

                        }

                      });

                  var oPlotPanel = Ext.create(&#39;Ext.panel.Panel&#39;, {
                        region : &quot;center&quot;,
                        layout : &quot;absolute&quot;,
                        items : [me.plotImage]

                      });

                  var oHrefParams = &quot;&quot;;

                  for (var oParam in me.plotParams) {

                    oHrefParams += ((oHrefParams == &quot;&quot;) ? &quot;&quot; : &quot;&amp;&quot;) + oParam + &quot;=&quot; + encodeURIComponent(me.plotParams[oParam]);

                  }

                  me.plotToolbar = new Ext.toolbar.Toolbar({
                        region : &quot;north&quot;,
                        items : [{
                              xtype : &quot;button&quot;,
                              text : &quot;Refresh&quot;,
                              handler : function() {

                                var oThisButton = this;
                                me.__loadSelectionData(me.plotParamsForSaveState);

                              },
                              iconCls : &quot;dirac-icon-refresh&quot;
                            }, me.btnStretchPlot, me.btnRefreshMenu, &#39;-&gt;&#39;, &quot;&lt;a target=&#39;_blank&#39; href=&#39;&quot; + GLOBAL.BASE_URL + &quot;AccountingPlot/getCsvPlotData?&quot; + oHrefParams + &quot;&#39;&gt;CSV data&lt;/a&gt;&quot;]
                      });

                  me.rightPanel.removeAll();

                  me.rightPanel.add([me.plotToolbar, oPlotPanel]);
                  me.rightPanel.setLoading(&#39;Loading Image ...&#39;);

                } else {
                  GLOBAL.APP.CF.alert(response[&quot;errors&quot;], &quot;error&quot;);
                }

              },
              failure : function(response, options) {
                GLOBAL.APP.CF.showAjaxErrorMessage(response);
              }
            });

      },

      __loadSelectionData : function(oParams) {

        var me = this;

        me.plotParams = oParams;

        if (!(&quot;_typeName&quot; in oParams))
          return;

        me.__additionalDataLoad = function() {

          me.cmbGroupBy.setValue(oParams[&quot;_grouping&quot;]);
          me.cmbPlotGenerate.setValue(oParams[&quot;_plotName&quot;]);
          me.cmbTimeSpan.setValue(oParams[&quot;_timeSelector&quot;]);

          me.calendarFrom.hide();
          me.calendarTo.hide();
          me.cmbQuarter.hide();

          switch (oParams[&quot;_timeSelector&quot;]) {

            case -1 :
              me.calendarFrom.setValue(oParams[&quot;_startTime&quot;]);
              me.calendarTo.setValue(oParams[&quot;_endTime&quot;]);
              me.calendarFrom.show();
              me.calendarTo.show();
              break;

            case -2 :
              var oNewQuartersArray = [];

              for (var i = 0; i &lt; oParams[&quot;_quarters&quot;].length; i++)
                oNewQuartersArray.push(parseInt(oParams[&quot;_quarters&quot;][i].replace(&quot; Q&quot;, &quot;&quot;)));

              me.cmbQuarter.setValue(oNewQuartersArray);
              me.cmbQuarter.show();
              break;

          }

          me.advancedPlotTitle.setValue(oParams[&quot;_plotTitle&quot;]);

          if (&quot;_pinDates&quot; in oParams) {

            if (oParams[&quot;_pinDates&quot;] == &quot;true&quot;)
              me.advancedPin.setValue(true);
            else
              me.advancedPin.setValue(false);

          } else
            me.advancedPin.setValue(false);

          if (&quot;_ex_staticUnits&quot; in oParams) {

            if (oParams[&quot;_ex_staticUnits&quot;] == &quot;true&quot;)
              me.advancedNotScaleUnits.setValue(true);
            else
              me.advancedNotScaleUnits.setValue(false);

          } else
            me.advancedNotScaleUnits.setValue(false);

          for (var i = 0; i &lt; me.fsetSpecialConditions.items.length; i++) {

            me.fsetSpecialConditions.items.getAt(i).setValue(null);

          }

          var oStandardParamsList = [&quot;_grouping&quot;, &quot;_plotName&quot;, &quot;_typeName&quot;, &quot;_timeSelector&quot;, &quot;_startTime&quot;, &quot;_endTime&quot;, &quot;_plotTitle&quot;, &quot;_pinDates&quot;, &quot;_ex_staticUnits&quot;];

          for (var oParam in oParams) {

            // first we check whether the param is not someone form the
            // default ones
            var oFound = false;

            for (var i = 0; i &lt; oStandardParamsList.length; i++) {

              if (oParam == oStandardParamsList[i]) {

                oFound = true;
                break;

              }

            }

            if (!oFound) {

              for (var i = 0; i &lt; me.fsetSpecialConditions.items.length; i++) {

                var oNewUnderlinedName = &quot;_&quot; + me.fsetSpecialConditions.items.getAt(i).getName();

                if (oNewUnderlinedName == oParam) {

                  me.fsetSpecialConditions.items.getAt(i).setInverseSelection((oParams[oParam][0] == 1));
                  me.fsetSpecialConditions.items.getAt(i).setValue(oParams[oParam][1].split(&quot;,&quot;));

                  break;

                }

              }

            }

          }

          if (me.__validateConditions(false)) {
            me.__generatePlot();
          }

        };

        if (me.cmbDomain.getValue() == oParams[&quot;_typeName&quot;]) {

          me.__additionalDataLoad();
          me.__additionalDataLoad = null;

        } else {

          me.cmbDomain.setValue(oParams[&quot;_typeName&quot;]);

        }

      }

    });
</pre>
</body>
</html>
