<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define(&#39;DIRAC.ActivityMonitor.classes.ActivityMonitor&#39;, {
      extend : &#39;Ext.dirac.core.Module&#39;,
      requires : [&#39;Ext.util.*&#39;, &#39;Ext.panel.Panel&#39;, &quot;Ext.form.field.Text&quot;, &quot;Ext.button.Button&quot;, &quot;Ext.menu.Menu&quot;, &quot;Ext.form.field.ComboBox&quot;, &quot;Ext.layout.*&quot;, &quot;Ext.form.field.Date&quot;, &quot;Ext.form.field.TextArea&quot;, &quot;Ext.form.field.Checkbox&quot;, &quot;Ext.form.FieldSet&quot;,
          &quot;Ext.dirac.utils.DiracMultiSelect&quot;, &quot;Ext.toolbar.Toolbar&quot;, &quot;Ext.data.Record&quot;, &#39;Ext.Array&#39;, &#39;Ext.data.TreeStore&#39;, &quot;Ext.ux.form.MultiSelect&quot;],

      expansionState : {},
      initComponent : function() {

        var me = this;
        me.launcher.title = &quot;Activity Monitor&quot;;

        if (GLOBAL.VIEW_ID == &quot;desktop&quot;) {

          me.launcher.maximized = true;

        }

        if (GLOBAL.VIEW_ID == &quot;tabs&quot;) {

        }

        Ext.apply(me, {
              layout : &#39;border&#39;,
              bodyBorder : false,
              defaults : {
                collapsible : true,
                split : true
              },
              items : [],
              header : false
            });

        me.callParent(arguments);

      },

      buildUI : function() {

        var me = this;

        var oToolb = Ext.create(&#39;Ext.toolbar.Toolbar&#39;, {
              dock : &#39;top&#39;,
              border : false,
              layout : {
                pack : &#39;center&#39;
              },
              items : [{
                    xtype : &quot;button&quot;,
                    text : &quot;Proxy Monitor&quot;,
                    handler : function() {
                      me.mainPanel.getLayout().setActiveItem(0);
                    },
                    toggleGroup : me.id + &quot;-ids-submodule&quot;,
                    allowDepress : false
                  }, {
                    xtype : &quot;button&quot;,
                    text : &quot;Plot Creator&quot;,
                    handler : function() {
                      me.mainPanel.getLayout().setActiveItem(1);
                    },
                    toggleGroup : me.id + &quot;-ids-submodule&quot;,
                    allowDepress : false
                  }, {
                    xtype : &quot;button&quot;,
                    text : &quot;Plot Viewer&quot;,
                    handler : function() {
                      me.mainPanel.getLayout().setActiveItem(2);
                    },
                    toggleGroup : me.id + &quot;-ids-submodule&quot;,
                    allowDepress : false
                  }, {
                    xtype : &quot;button&quot;,
                    text : &quot;System overview plots&quot;,
                    handler : function() {
                      me.mainPanel.getLayout().setActiveItem(3);
                    },
                    toggleGroup : me.id + &quot;-ids-submodule&quot;,
                    allowDepress : false
                  }]
            });

        oToolb.items.getAt(0).toggle();

        me.mainPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              floatable : false,
              layout : &#39;card&#39;,
              region : &quot;center&quot;,
              header : false,
              border : false,
              dockedItems : [oToolb]
            });

        me.__buildActivityMonitor();
        me.__buildPlotManagement();
        me.__buildPlotViewer();
        me.__buildSystemViewer();

        me.add([me.mainPanel]);

      },

      __buildActivityMonitor : function() {

        var me = this;

        me.activityMonitorDataStore = new Ext.data.JsonStore({

              proxy : {
                type : &#39;ajax&#39;,
                url : GLOBAL.BASE_URL + &#39;ActivityMonitor/getActivityData&#39;,
                reader : {
                  type : &#39;json&#39;,
                  root : &#39;result&#39;
                },
                timeout : 1800000
              },
              autoLoad : true,
              fields : [{
                    name : &#39;sources_id&#39;,
                    type : &#39;int&#39;
                  }, &#39;sources_site&#39;, &#39;sources_componentType&#39;, &#39;sources_componentLocation&#39;, &#39;sources_componentName&#39;, {
                    name : &#39;activities_id&#39;,
                    type : &#39;int&#39;
                  }, &#39;activities_name&#39;, &#39;activities_category&#39;, &#39;activities_unit&#39;, &#39;activities_type&#39;, &#39;activities_description&#39;, {
                    name : &#39;activities_bucketLength&#39;,
                    type : &#39;int&#39;
                  }, &#39;activities_filename&#39;, {
                    name : &#39;activities_lastUpdate&#39;,
                    type : &#39;float&#39;
                  }],
              remoteSort : true,
              pageSize : 100,
              listeners : {

                load : function(oStore, records, successful, eOpts) {

                  var bResponseOK = (oStore.proxy.reader.rawData[&quot;success&quot;] == &quot;true&quot;);

                  if (!bResponseOK) {

                    GLOBAL.APP.CF.alert(oStore.proxy.reader.rawData[&quot;error&quot;], &quot;info&quot;);

                    if (parseInt(oStore.proxy.reader.rawData[&quot;total&quot;], 10) == 0) {

                      me.dataStore.removeAll();

                    }

                  }

                }

              }
            });

        var oDeleteSelectedActivities = new Ext.Button({
              text : &quot;Delete&quot;,
              iconCls : &quot;dirac-icon-delete&quot;,
              handler : function() {

                var oElems = Ext.query(&quot;#&quot; + me.activityMonitorPanel.id + &quot; input.checkrow&quot;);

                var oItems = [];

                for (var i = 0; i &lt; oElems.length; i++)
                  if (oElems[i].checked)
                    oItems.push(oElems[i].value);

                if (oItems.length &lt; 1) {
                  GLOBAL.APP.CF.alert(&#39;No jobs were selected&#39;, &quot;error&quot;);
                  return;
                }

                Ext.Ajax.request({
                      url : GLOBAL.BASE_URL + &#39;ActivityMonitor/deleteActivities&#39;,
                      params : {
                        &quot;ids&quot; : oItems.join(&quot;,&quot;)
                      },
                      scope : me,
                      success : function(response) {

                        me.activityMonitorDataStore.store.load();

                      }
                    });
              },
              tooltip : &quot;Click to delete all selected proxies&quot;
            });

        me.activityMonitorToolbar = Ext.create(&#39;Ext.toolbar.Paging&#39;, {
              store : me.activityMonitorDataStore,
              displayInfo : true,
              displayMsg : &#39;Displaying topics {0} - {1} of {2}&#39;,
              items : [oDeleteSelectedActivities, &quot;-&gt;&quot;],
              prependButtons : true,
              emptyMsg : &quot;No topics to display&quot;,
              layout : {
                overflowHandler : &#39;Scroller&#39;
              }
            });

        var sGridId = Ext.id();

        var sCheckboxDefinition = &quot;&quot;;
        sCheckboxDefinition += &#39;&lt;input type=&quot;checkbox&quot; value=&quot;&quot; onchange=&quot;&#39;;
        sCheckboxDefinition += &#39;var oChecked=this.checked;&#39;;
        sCheckboxDefinition += &#39;var oElems=Ext.query(\&#39;#&#39; + sGridId + &#39; input.checkrow\&#39;);&#39;;
        sCheckboxDefinition += &#39;for(var i=0;i&lt;oElems.length;i++)oElems[i].checked = oChecked;&#39;;
        sCheckboxDefinition += &#39;&quot; class=&quot;am-main-check-box&quot;/&gt;&#39;;

        me.activityMonitorPanel = Ext.create(&#39;Ext.grid.Panel&#39;, {
              store : me.activityMonitorDataStore,
              id : sGridId,
              header : false,
              viewConfig : {
                stripeRows : true,
                enableTextSelection : true
              },
              columns : [{
                    header : sCheckboxDefinition,
                    name : &#39;checkBox&#39;,
                    width : 26,
                    sortable : false,
                    dataIndex : &#39;activities_id&#39;,
                    renderer : function(value, metaData, record, row, col, store, gridView) {
                      return this.rendererChkBox(record);
                    },
                    hideable : false,
                    fixed : true,
                    menuDisabled : true,
                    align : &quot;center&quot;
                  }, {
                    header : &quot;Site&quot;,
                    sortable : true,
                    dataIndex : &#39;sources_site&#39;
                  }, {
                    header : &quot;Component Type&quot;,
                    sortable : true,
                    dataIndex : &#39;sources_componentType&#39;
                  }, {
                    header : &quot;Location&quot;,
                    sortable : true,
                    dataIndex : &#39;sources_componentLocation&#39;,
                    flex : 1
                  }, {
                    header : &quot;Component name&quot;,
                    sortable : true,
                    dataIndex : &#39;sources_componentName&#39;,
                    flex : 1
                  }, {
                    header : &quot;Activity name&quot;,
                    sortable : true,
                    dataIndex : &#39;activities_name&#39;
                  }, {
                    header : &quot;Category&quot;,
                    sortable : true,
                    dataIndex : &#39;activities_category&#39;
                  }, {
                    header : &quot;Unit&quot;,
                    sortable : true,
                    dataIndex : &#39;activities_unit&#39;
                  }, {
                    header : &quot;Activity type&quot;,
                    sortable : true,
                    dataIndex : &#39;activities_type&#39;
                  }, {
                    header : &quot;Description&quot;,
                    sortable : true,
                    dataIndex : &#39;activities_description&#39;
                  }, {
                    header : &quot;Bucket size&quot;,
                    sortable : true,
                    dataIndex : &#39;activities_bucketLength&#39;
                  }, {
                    header : &quot;File&quot;,
                    sortable : true,
                    dataIndex : &#39;activities_filename&#39;
                  }, {
                    header : &quot;Last update&quot;,
                    sortable : true,
                    dataIndex : &#39;activities_lastUpdate&#39;,
                    renderer : function(value, metaData, record, row, col, store, gridView) {
                      return this.renderLastUpdate(value, metaData, record, row, col, store, gridView);
                    }
                  }],
              rendererChkBox : function(record) {
                return &#39;&lt;input value=&quot;&#39; + record.get(&quot;sources_id&quot;) + &quot;.&quot; + record.get(&quot;activities_id&quot;) + &#39;&quot; type=&quot;checkbox&quot; class=&quot;checkrow&quot; style=&quot;margin:0px;padding:0px&quot;/&gt;&#39;;
              },
              renderLastUpdate : function(value, metadata, record, rowIndex, colIndex, store) {
                var lastUpdated = record.data.activities_lastUpdate;
                var timeLimit = 86400 * 30;
                if (lastUpdated &gt; timeLimit)
                  lastUpdated = timeLimit;
                var green = parseInt(200 * (timeLimit - lastUpdated) / timeLimit);
                var red = parseInt(200 * (lastUpdated) / timeLimit);
                return &#39;&lt;span style=&quot;color: rgb(&#39; + red + &#39;,&#39; + green + &#39;,0);&quot;&gt;&#39; + lastUpdated + &#39;&lt;/span&gt;&#39;;
              },
              bbar : me.activityMonitorToolbar
            });

        me.htmlDescriptionVariables = &quot;&quot;;
        me.htmlDescriptionVariables += &quot;&lt;table style=&#39;width:100%&#39;&gt;&quot;;
        me.htmlDescriptionVariables += &quot;&lt;tr&gt;&quot;;
        me.htmlDescriptionVariables += &quot;&lt;td style=&#39;width:50%;background-color:#eeeeee;font-weight:bold;padding:5px&#39;&gt;&quot;;
        me.htmlDescriptionVariables += &quot;Variable Name&quot;;
        me.htmlDescriptionVariables += &quot;&lt;/td&gt;&quot;;
        me.htmlDescriptionVariables += &quot;&lt;td style=&#39;width:50%;background-color:#eeeeee;font-weight:bold;padding:5px&#39;&gt;&quot;;
        me.htmlDescriptionVariables += &quot;Description&quot;;
        me.htmlDescriptionVariables += &quot;&lt;/td&gt;&quot;;
        me.htmlDescriptionVariables += &quot;&lt;/tr&gt;&quot;;

        var oVariables = [[&quot;$DESCRIPTION&quot;, &quot;Description of the activity&quot;], [&quot;$SITE&quot;, &quot;Site for the originating component&quot;], [&quot;$COMPONENTTYPE&quot;, &quot;Type of component to generate the activity (for example: service, agent, web)&quot;], [&quot;$COMPONENTNAME&quot;, &quot;Full name of component&quot;],
            [&quot;$COMPONENTLOCATION&quot;, &quot;	Location of component&quot;], [&quot;$UNIT&quot;, &quot;Activity unit&quot;], [&quot;$CATEGORY&quot;, &quot;Activity category&quot;]];

        for (var i = 0; i &lt; oVariables.length; i++) {
          me.htmlDescriptionVariables += &quot;&lt;tr&gt;&quot;;
          me.htmlDescriptionVariables += &quot;&lt;td style=&#39;width:50%;font-weight:bold;padding:5px&#39;&gt;&quot;;
          me.htmlDescriptionVariables += oVariables[i][0];
          me.htmlDescriptionVariables += &quot;&lt;/td&gt;&quot;;
          me.htmlDescriptionVariables += &quot;&lt;td style=&#39;width:50%;padding:5px&#39;&gt;&quot;;
          me.htmlDescriptionVariables += oVariables[i][1];
          me.htmlDescriptionVariables += &quot;&lt;/td&gt;&quot;;
          me.htmlDescriptionVariables += &quot;&lt;/tr&gt;&quot;;
        }

        me.htmlDescriptionVariables += &quot;&lt;/table&gt;&quot;;

        me.mainPanel.add([me.activityMonitorPanel]);

      },

      __buildPlotManagement : function() {

        var me = this;

        me.plotManagementMainPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              floatable : false,
              layout : &#39;border&#39;,
              header : false,
              border : false,
              items : [],
              defaults : {
                collapsible : true,
                split : true
              }
            });

        var sGridId = Ext.id();

        var sCheckboxDefinition = &quot;&quot;;
        sCheckboxDefinition += &#39;&lt;input type=&quot;checkbox&quot; value=&quot;&quot; onchange=&quot;&#39;;
        sCheckboxDefinition += &#39;var oChecked=this.checked;&#39;;
        sCheckboxDefinition += &#39;var oElems=Ext.query(\&#39;#&#39; + sGridId + &#39; input.checkrow\&#39;);&#39;;
        sCheckboxDefinition += &#39;for(var i=0;i&lt;oElems.length;i++)oElems[i].checked = oChecked;&#39;;
        sCheckboxDefinition += &#39;&quot; class=&quot;am-main-check-box&quot;/&gt;&#39;;

        me.plotManagementListPanel = Ext.create(&#39;Ext.grid.Panel&#39;, {
              region : &quot;south&quot;,
              height : 300,
              store : null,
              header : false,
              viewConfig : {
                stripeRows : true,
                enableTextSelection : true
              },
              columns : [{
                    header : sCheckboxDefinition,
                    name : &#39;checkBox&#39;,
                    width : 26,
                    sortable : false,
                    dataIndex : &#39;id&#39;,
                    renderer : function(value, metaData, record, row, col, store, gridView) {
                      return this.rendererChkBox(value);
                    },
                    hideable : false,
                    fixed : true,
                    menuDisabled : true,
                    align : &quot;center&quot;
                  }, {
                    header : &quot;Name&quot;,
                    sortable : true,
                    width : 300,
                    dataIndex : &#39;name&#39;
                  }, {
                    header : &quot;Variable Fields&quot;,
                    sortable : true,
                    dataIndex : &#39;variable_fields&#39;,
                    flex : 1
                  }],
              refreshData : function() {

                Ext.Ajax.request({
                      url : GLOBAL.BASE_URL + &#39;ActivityMonitor/getStaticPlotViews&#39;,
                      scope : me,
                      success : function(response) {

                        var me = this;
                        var response = Ext.JSON.decode(response.responseText);

                        me.plotManagementListPanel.reconfigure(new Ext.data.ArrayStore({
                                  fields : [&#39;id&#39;, &#39;name&#39;, &#39;variable_fields&#39;],
                                  data : response.result
                                }), undefined);
                      }
                    });

              },
              rendererChkBox : function(val) {
                return &#39;&lt;input value=&quot;&#39; + val + &#39;&quot; type=&quot;checkbox&quot; class=&quot;checkrow&quot; style=&quot;margin:0px;padding:0px&quot;/&gt;&#39;;
              },
              dockedItems : [{
                    dock : &quot;top&quot;,
                    xtype : &quot;toolbar&quot;,
                    border : false,
                    items : [&quot;-&gt;&quot;, {
                          xtype : &quot;button&quot;,
                          iconCls : &quot;dirac-icon-delete&quot;,
                          text : &quot;Delete&quot;,
                          handler : function() {
                          }
                        }],
                    tooltip : &quot;Delete selected views&quot;
                  }]
            });

        me.plotManagementListPanel.refreshData();

        // -------------------------------------------------------------------------------------

        var oTopPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              region : &quot;center&quot;,
              floatable : false,
              layout : &#39;border&#39;,
              header : false,
              defaults : {
                collapsible : true,
                split : true
              }
            });

        me.viewDefinitionData = {};
        me.viewDefinitionDataForServer = {};
        me.viewDefinitionDataForServerVariable = [];

        me.plotManagementFieldCreator = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              region : &quot;west&quot;,
              floatable : false,
              layout : &#39;anchor&#39;,
              header : false,
              width : 350,
              bodyPadding : 5,
              dockedItems : [{
                    dock : &quot;top&quot;,
                    xtype : &quot;toolbar&quot;,
                    border : false,
                    layout : {
                      pack : &#39;center&#39;
                    },
                    items : [&quot;-&gt;&quot;, {
                          xtype : &quot;button&quot;,
                          iconCls : &quot;dirac-icon-plus&quot;,
                          text : &quot;Add to view definition&quot;,
                          handler : function() {

                            var sTypeValue = me.restrictByFieldCreator.getValue();
                            var oSelectedValues = me.valuesFieldCreator.getValue();

                            if (sTypeValue == null) {

                              GLOBAL.APP.CF.alert(&quot;No data type selected !&quot;, &quot;warning&quot;);
                              return;

                            }

                            if ((me.variableFieldCreator.getValue()) || ((!me.variableFieldCreator.getValue()) &amp;&amp; (oSelectedValues.length &gt; 0))) {

                              var sTypeText = me.restrictByFieldCreator.findRecordByValue(sTypeValue).get(&quot;text&quot;);

                              me.viewDefinitionData[sTypeText] = {
                                &quot;value&quot; : sTypeValue,
                                &quot;checked&quot; : me.variableFieldCreator.getValue()
                              };

                              if (me.variableFieldCreator.getValue())
                                me.viewDefinitionDataForServerVariable.push(sTypeValue);
                              else
                                me.viewDefinitionDataForServer[sTypeValue] = oSelectedValues;

                              oNodeData = {
                                &quot;text&quot; : sTypeText,
                                &quot;leaf&quot; : false
                              };
                              var oRoot = me.plotManagementViewTreeStore.getRootNode();

                              var oTypeNode = oRoot.createNode(oNodeData);
                              oRoot.appendChild(oTypeNode);

                              if (me.variableFieldCreator.getValue()) {

                                var oNewNode = oTypeNode.createNode({
                                      &quot;text&quot; : &quot;variable value&quot;,
                                      &quot;leaf&quot; : true
                                    });
                                oTypeNode.appendChild(oNewNode);

                              } else {

                                for (var i = 0; i &lt; oSelectedValues.length; i++) {
                                  var oNewNode = oTypeNode.createNode({
                                        &quot;text&quot; : oSelectedValues[i],
                                        &quot;leaf&quot; : true
                                      });
                                  oTypeNode.appendChild(oNewNode);
                                }

                              }

                              oRoot.expand();
                              oTypeNode.expand();

                              // we have to remove the selected option

                              me.restrictByFieldCreator.store.remove(me.restrictByFieldCreator.findRecordByValue(sTypeValue));

                              // we have to set the value to null
                              me.restrictByFieldCreator.setValue(null);
                              me.valuesFieldCreator.store.removeAll();
                              me.valuesFieldCreator.reset();

                            } else {
                              GLOBAL.APP.CF.alert(&quot;No values have been selected !&quot;, &quot;warning&quot;);
                            }

                          }
                        }]
                  }]
            });

        me.restrictByFieldCreator = Ext.create(&#39;Ext.form.field.ComboBox&#39;, {
              fieldLabel : &quot;Restrict by&quot;,
              queryMode : &#39;local&#39;,
              labelAlign : &#39;left&#39;,
              displayField : &quot;text&quot;,
              valueField : &quot;value&quot;,
              anchor : &#39;100%&#39;,
              editable : false,
              store : new Ext.data.ArrayStore({
                    fields : [&#39;value&#39;, &#39;text&#39;],
                    data : [[&quot;sources.site&quot;, &quot;Site&quot;], [&quot;sources.componentType&quot;, &quot;Component type&quot;], [&quot;sources.componentLocation&quot;, &quot;Component location&quot;], [&quot;sources.componentName&quot;, &quot;Component name&quot;], [&quot;activities.description&quot;, &quot;Activity&quot;],
                        [&quot;activities.category&quot;, &quot;Activity category&quot;]]
                  }),
              value : null,
              listeners : {
                change : function(oComp, sNewValue, sOldValue, eOpts) {

                  if ((sNewValue != null) &amp;&amp; (Ext.util.Format.trim(sNewValue) != &quot;&quot;)) {

                    Ext.Ajax.request({
                          url : GLOBAL.BASE_URL + &#39;ActivityMonitor/queryFieldValue&#39;,
                          params : {
                            queryField : sNewValue,
                            selectedFields : Ext.JSON.encode(me.viewDefinitionDataForServer)
                          },
                          scope : me,
                          success : function(response) {

                            var response = Ext.JSON.decode(response.responseText);

                            if (response[&quot;success&quot;] == &#39;true&#39;) {

                              me.valuesFieldCreator.store.removeAll();

                              oData = response.result;

                              for (var i = 0; i &lt; oData.length; i++) {
                                me.valuesFieldCreator.store.add({
                                      &quot;value&quot; : Ext.util.Format.trim(oData[i][0])
                                    });
                              }

                              me.valuesFieldCreator.reset();

                            } else {

                              GLOBAL.APP.CF.alert(response[&quot;error&quot;], &quot;warning&quot;);

                            }

                          }
                        });

                  }

                }
              }
            });

        me.valuesFieldCreator = new Ext.ux.form.MultiSelect({
              fieldLabel : &quot;Having values&quot;,
              queryMode : &#39;local&#39;,
              labelAlign : &#39;left&#39;,
              displayField : &quot;value&quot;,
              valueField : &quot;value&quot;,
              anchor : &#39;100%&#39;,
              height : 150,
              store : new Ext.data.ArrayStore({
                    fields : [&#39;value&#39;],
                    data : []
                  })
            });

        me.variableFieldCreator = Ext.create(&#39;Ext.form.field.Checkbox&#39;, {

              fieldLabel : &quot;Variable field&quot;,
              labelAlign : &quot;left&quot;

            });

        me.plotManagementFieldCreator.add([me.restrictByFieldCreator, me.valuesFieldCreator, me.variableFieldCreator]);

        // -------------------------------------------------------------------------------------

        me.plotManagementViewOptions = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              region : &quot;east&quot;,
              floatable : false,
              layout : &#39;anchor&#39;,
              header : false,
              width : 350,
              bodyPadding : 5,
              dockedItems : [{
                    dock : &quot;top&quot;,
                    xtype : &quot;toolbar&quot;,
                    border : false,
                    layout : {
                      pack : &#39;center&#39;
                    },
                    items : [&quot;-&gt;&quot;, {
                          xtype : &quot;button&quot;,
                          text : &quot;Test View&quot;,
                          handler : function() {
                            me.oprTestView();
                          }
                        }]
                  }]
            });

        me.checkGroupByViewOptions = new Ext.create(&quot;Ext.form.CheckboxGroup&quot;, {

              columns : 1,
              vertical : true,
              items : [{
                    boxLabel : &#39;Site&#39;,
                    name : &#39;rb&#39;,
                    inputValue : &#39;sources.site&#39;
                  }, {
                    boxLabel : &#39;Component type&#39;,
                    name : &#39;rb&#39;,
                    inputValue : &#39;sources.componentType&#39;,
                    checked : true
                  }, {
                    boxLabel : &#39;Component location&#39;,
                    name : &#39;rb&#39;,
                    inputValue : &#39;sources.componentLocation&#39;
                  }, {
                    boxLabel : &#39;Component name&#39;,
                    name : &#39;rb&#39;,
                    inputValue : &#39;sources.componentName&#39;
                  }, {
                    boxLabel : &#39;Activity&#39;,
                    name : &#39;rb&#39;,
                    inputValue : &#39;activities.description&#39;
                  }, {
                    boxLabel : &#39;Activity category&#39;,
                    name : &#39;rb&#39;,
                    inputValue : &#39;activities.category&#39;
                  }]

            });

        me.txtActivityLabelViewOptions = Ext.create(&#39;Ext.form.field.Text&#39;, {

              fieldLabel : &quot;Activities label&quot;,
              labelAlign : &quot;left&quot;,
              value : &quot;$DESCRIPTION&quot;,
              anchor : &quot;100%&quot;

            });

        me.txtViewNameViewOptions = Ext.create(&#39;Ext.form.field.Text&#39;, {

              fieldLabel : &quot;View name&quot;,
              labelAlign : &quot;left&quot;,
              anchor : &quot;100%&quot;

            });

        me.txtStackActivityViewOptions = Ext.create(&#39;Ext.form.field.Checkbox&#39;, {

              fieldLabel : &quot;Stack activities&quot;,
              labelAlign : &quot;left&quot;

            });

        me.plotManagementViewOptions.add([{
              xtype : &#39;fieldset&#39;,
              columnWidth : 0.5,
              title : &#39;Group plots by&#39;,
              collapsible : true,
              items : [me.checkGroupByViewOptions]
            }, me.txtActivityLabelViewOptions, me.txtStackActivityViewOptions, me.txtViewNameViewOptions]);

        // -------------------------------------------------------------------------------------

        me.contextTreeMenu = new Ext.menu.Menu({
              width : 150,
              items : [{
                    text : &#39;Delete&#39;,
                    iconCls : &quot;dirac-icon-delete&quot;,
                    listeners : {
                      click : function() {
                        var oNode = me.contextTreeMenu.node;

                        if (oNode.isLeaf()) {
                          oNode = oNode.parentNode;
                        }

                        var sType = oNode.raw.text;

                        me.restrictByFieldCreator.store.add({
                              &quot;value&quot; : me.viewDefinitionData[sType].value,
                              &quot;text&quot; : sType
                            });

                        if (me.viewDefinitionData[sType].value in me.viewDefinitionDataForServer) {
                          delete me.viewDefinitionDataForServer[me.viewDefinitionData[sType].value]
                        } else {
                          Ext.Array.remove(me.viewDefinitionDataForServerVariable, me.viewDefinitionData[sType].value);
                        }

                        delete me.viewDefinitionData[sType]

                        var oParentNode = oNode.parentNode;
                        oParentNode.removeChild(oNode);

                      }
                    }
                  }],
              moduleObject : me
            });

        me.plotManagementViewTreeStore = Ext.create(&#39;Ext.data.TreeStore&#39;, {
              proxy : {
                type : &#39;localstorage&#39;,
                id : me.id + &#39;treeStoreLocalStorage&#39;
              },
              root : {
                text : &#39;View Definition&#39;
              }
            });

        me.plotManagementViewTree = new Ext.create(&#39;Ext.tree.Panel&#39;, {
              region : &#39;center&#39;,
              store : me.plotManagementViewTreeStore,
              header : false,
              listeners : {

                beforeitemcontextmenu : function(oView, oNode, item, index, e, eOpts) {

                  e.preventDefault();
                  if (oNode.raw.id != &quot;root&quot;) {
                    me.contextTreeMenu.node = oNode;
                    me.contextTreeMenu.showAt(e.xy);
                  }

                }

              }
            });

        // -------------------------------------------------------------------------------------
        oTopPanel.add([me.plotManagementFieldCreator, me.plotManagementViewOptions, me.plotManagementViewTree]);
        me.plotManagementMainPanel.add([me.plotManagementListPanel, oTopPanel]);

        me.mainPanel.add(me.plotManagementMainPanel);

      },

      __buildPlotViewer : function() {

        var me = this;

        me.plotViewerMainPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              floatable : false,
              layout : &#39;border&#39;,
              header : false,
              border : false,
              defaults : {
                collapsible : true,
                split : true
              }
            });

        Ext.Ajax.request({
              url : GLOBAL.BASE_URL + &#39;ActivityMonitor/getStaticPlotViews&#39;,
              scope : me,
              success : function(response) {

                var me = this;
                var response = Ext.JSON.decode(response.responseText);

                me.plotViewerListPanel.reconfigure(new Ext.data.ArrayStore({
                          fields : [&#39;id&#39;, &#39;name&#39;, &#39;variable_fields&#39;],
                          data : response.result
                        }), undefined);
              }
            });

        me.plotViewerListPanel = Ext.create(&#39;Ext.grid.Panel&#39;, {
              region : &quot;west&quot;,
              width : 250,
              store : null,
              header : false,
              viewConfig : {
                stripeRows : true,
                enableTextSelection : true
              },
              columns : [{
                    header : &quot;Click on a view to plot it&quot;,
                    sortable : true,
                    dataIndex : &#39;name&#39;,
                    flex : 1
                  }],
              listeners : {

                cellclick : function(oTable, td, cellIndex, record, tr, rowIndex, e, eOpts) {

                  me.plotViewerResultPanel.removeAll();

                  var oNewPlots = me.__buildPlotView(record.get(&quot;name&quot;), &quot;&quot;);

                  me.plotViewerResultPanel.add(oNewPlots);

                }

              }

            });

        me.plotViewerResultPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              floatable : false,
              region : &quot;center&quot;,
              layout : &quot;border&quot;,
              header : false,
              border : false,
              items : []
            });

        me.plotViewerMainPanel.add([me.plotViewerListPanel, me.plotViewerResultPanel]);
        me.mainPanel.add([me.plotViewerMainPanel]);

      },

      __buildPlotView : function(sViewId, sVariableData) {

        var me = this;

        var oMainPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              floatable : false,
              region : &quot;center&quot;,
              layout : &#39;border&#39;,
              header : false,
              items : [],
              viewId : sViewId
            });

        var oLeftPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              title : &quot;Activity view options&quot;,
              floatable : false,
              region : &quot;west&quot;,
              layout : &quot;anchor&quot;,
              width : 300,
              bodyPadding : 10,
              items : []
            });

        var oRightPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              floatable : false,
              region : &quot;center&quot;,
              header : false,
              autoScroll : true,
              layout : {
                type : &#39;table&#39;,
                columns : 1
              }
            });

        var oCalenFrom = new Ext.create(&#39;Ext.form.field.Date&#39;, {
              width : 100,
              format : &#39;Y-m-d&#39;,
              fieldLabel : &quot;From&quot;,
              labelAlign : &quot;left&quot;,
              hidden : true,
              anchor : &quot;100%&quot;
            });

        var oCalenTo = new Ext.create(&#39;Ext.form.field.Date&#39;, {
              width : 100,
              format : &#39;Y-m-d&#39;,
              fieldLabel : &quot;To&quot;,
              labelAlign : &quot;left&quot;,
              hidden : true,
              anchor : &quot;100%&quot;
            });

        var oTimeSpan = new Ext.create(&#39;Ext.form.field.ComboBox&#39;, {
              labelAlign : &#39;left&#39;,
              fieldLabel : &#39;Time Span&#39;,
              editable : false,
              store : new Ext.data.ArrayStore({
                    fields : [&#39;value&#39;, &#39;text&#39;],
                    data : [[3600, &quot;Last Hour&quot;], [86400, &quot;Last Day&quot;], [604800, &quot;Last Week&quot;], [2592000, &quot;Last Month&quot;], [-1, &quot;Manual Selection&quot;]]
                  }),
              displayField : &quot;text&quot;,
              valueField : &quot;value&quot;,
              anchor : &quot;100%&quot;,
              value : 86400,
              listeners : {
                change : function(field, newValue, oldValue, eOpts) {

                  oCalenFrom.hide();
                  oCalenTo.hide();

                  switch (newValue) {

                    case -1 :
                      oCalenFrom.show();
                      oCalenTo.show();
                      break;
                  }

                }
              }
            });

        var oPlotSize = new Ext.create(&#39;Ext.form.field.ComboBox&#39;, {
              labelAlign : &#39;left&#39;,
              fieldLabel : &#39;Plot Size&#39;,
              editable : false,
              store : new Ext.data.ArrayStore({
                    fields : [&#39;value&#39;, &#39;text&#39;],
                    data : [[0, &quot;Small&quot;], [1, &quot;Medium&quot;], [2, &quot;Big&quot;], [3, &quot;Very Big&quot;]]
                  }),
              displayField : &quot;text&quot;,
              valueField : &quot;value&quot;,
              anchor : &quot;100%&quot;,
              value : 1
            });

        oLeftPanel.add([oTimeSpan, oCalenFrom, oCalenTo, oPlotSize]);

        var oToolbar = new Ext.create(&#39;Ext.toolbar.Toolbar&#39;, {
              dock : &#39;bottom&#39;,
              border : false,
              layout : {
                pack : &#39;center&#39;
              },
              items : []
            });

        var oSubmitBtn = new Ext.Button({

              text : &#39;Submit&#39;,
              margin : 3,
              iconCls : &quot;dirac-icon-submit&quot;,
              handler : function() {
                oRightPanel.setLoading(true);
                var oParams = {};
                var bValid = true;

                oParams[&quot;id&quot;] = sViewId;

                if (oTimeSpan.getValue() == -1) {

                  if ((oCalenFrom.getValue() == null) || (Ext.Date.format(oCalenFrom.getValue(), &quot;Y-m-d&quot;) == &quot;&quot;)) {
                    GLOBAL.APP.CF.alert(&quot;Select a from date&quot;, &quot;warning&quot;);
                    bValid = false;
                  }

                  if ((oCalenTo.getValue() == null) || (Ext.Date.format(oCalenTo.getValue(), &quot;Y-m-d&quot;) == &quot;&quot;)) {
                    GLOBAL.APP.CF.alert(&quot;Select a to date&quot;, &quot;warning&quot;);
                    bValid = false;
                  }

                  oParams[&quot;timespan&quot;] = -1;
                  oParams[&quot;fromDate&quot;] = Ext.Date.format(oCalenFrom.getValue(), &quot;Y-m-d&quot;);
                  oParams[&quot;toDate&quot;] = Ext.Date.format(oCalenTo.getValue(), &quot;Y-m-d&quot;);

                } else {

                  oParams[&quot;timespan&quot;] = oTimeSpan.getValue();

                }

                if (sVariableData) {
                  oParams[&#39;varData&#39;] = Ext.encode(sVariableData);
                }

                oParams[&quot;size&quot;] = oPlotSize.getValue();

                if (bValid) {
                  Ext.Ajax.request({
                        url : GLOBAL.BASE_URL + &#39;ActivityMonitor/plotView&#39;,
                        params : oParams,
                        scope : me,
                        success : function(response) {
                          oRightPanel.setLoading(false);
                          var me = this;
                          var response = Ext.JSON.decode(response.responseText);

                          if (response.success == &quot;true&quot;) {

                            var plotsList = response.data;
                            if (plotsList.length) {

                              oRightPanel.removeAll();

                              for (var i = 0; i &lt; plotsList.length; i++) {

                                var oNewImage = Ext.create(&#39;Ext.Img&#39;, {
                                      region : &quot;center&quot;,
                                      src : GLOBAL.BASE_URL + &quot;ActivityMonitor/getPlotImg?file=&quot; + plotsList[i]
                                    });

                                oRightPanel.add(oNewImage);

                              }

                            }

                          } else {

                            GLOBAL.APP.CF.alert(response.error, &quot;warning&quot;);

                          }
                        }
                      });
                }
              }
            });

        var oResetBtn = new Ext.Button({

              text : &#39;Reset&#39;,
              margin : 3,
              iconCls : &quot;dirac-icon-reset&quot;,
              handler : function() {
              }
            });

        oToolbar.add([oSubmitBtn, oResetBtn]);

        oLeftPanel.addDocked([oToolbar]);

        oMainPanel.add([oLeftPanel, oRightPanel]);

        return oMainPanel;

      },

      generateViewRequest : function() {

        var me = this;

        if (me.viewDefinitionDataForServer.length == 0) {
          GLOBAL.APP.CF.alert(&quot;Select at least one non variable restriction&quot;, &quot;warning&quot;);
          return;
        }

        var oGrouping = me.checkGroupByViewOptions.getValue().rb;

        var sActDesc = me.txtActivityLabelViewOptions.getValue();
        if (!sActDesc) {
          GLOBAL.APP.CF.alert(&quot;Write the activities description&quot;, &quot;warning&quot;);
          return;
        }

        var bStack = false;
        if (me.txtStackActivityViewOptions.getValue())
          var bStack = true;

        return Ext.JSON.encode({
              &#39;groupBy&#39; : oGrouping,
              &#39;definition&#39; : me.viewDefinitionDataForServer,
              &#39;variable&#39; : me.viewDefinitionDataForServerVariable,
              &#39;stacked&#39; : bStack,
              &#39;label&#39; : sActDesc
            });

      },

      oprTestView : function() {

        var me = this;

        var sViewRequest = me.generateViewRequest();

        if (!sViewRequest)
          return;

        var sViewName = Ext.util.Format.trim(me.txtViewNameViewOptions.getValue());

        if (sViewName.length == 0) {
          GLOBAL.APP.CF.alert(&quot;The name of the view is missing.&quot;, &quot;warning&quot;);
          return;
        }

        me.getContainer().body.mask(&quot;Wait ...&quot;);
        Ext.Ajax.request({
              url : GLOBAL.BASE_URL + &#39;ActivityMonitor/tryView&#39;,
              success : function(response) {

                var response = Ext.JSON.decode(response.responseText);

                if (response.success == &quot;true&quot;) {

                  var plotsList = response.images;
                  if (plotsList.length) {

                    var oWindow = me.getContainer().createChildWindow(sViewName, false, 700, 500);

                    var oPlotContainer = Ext.create(&#39;Ext.panel.Panel&#39;, {
                          floatable : false,
                          region : &quot;center&quot;,
                          header : false,
                          autoScroll : true,
                          layout : {
                            type : &#39;table&#39;,
                            columns : 1
                          },
                          dockedItems : [{
                                xtype : &quot;toolbar&quot;,
                                dock : &#39;top&#39;,
                                items : [{
                                      xtype : &quot;button&quot;,
                                      text : &quot;Save view&quot;,
                                      handler : function() {

                                        var sViewRequest = me.generateViewRequest();

                                        if (!sViewRequest)
                                          return;

                                        var sViewName = Ext.util.Format.trim(me.txtViewNameViewOptions.getValue());

                                        if (sViewName.length == 0) {
                                          GLOBAL.APP.CF.alert(&quot;The name of the view is missing.&quot;, &quot;warning&quot;);
                                          return;
                                        }

                                        me.getContainer().body.mask(&quot;Wait ...&quot;);
                                        Ext.Ajax.request({
                                              url : GLOBAL.BASE_URL + &#39;ActivityMonitor/saveView&#39;,
                                              success : function(response) {
                                                var response = Ext.JSON.decode(response.responseText);

                                                if (response.success == &quot;true&quot;) {

                                                  me.plotManagementListPanel.store.load();

                                                } else {

                                                  GLOBAL.APP.CF.alert(&quot;Error: &quot; + response.error, &quot;warning&quot;);
                                                }

                                                me.getContainer().body.unmask();
                                              },
                                              failure : function(oRequest) {
                                                GLOBAL.APP.CF.showAjaxErrorMessage(response);
                                                me.getContainer().body.unmask();
                                              },
                                              params : {
                                                &#39;plotRequest&#39; : sViewRequest,
                                                &#39;viewName&#39; : sViewName
                                              }
                                            });
                                      }
                                    }]
                              }]
                        });

                    for (var i = 0; i &lt; plotsList.length; i++) {

                      var oNewImage = Ext.create(&#39;Ext.Img&#39;, {
                            src : GLOBAL.BASE_URL + &quot;ActivityMonitor/getPlotImg?file=&quot; + plotsList[i]
                          });

                      oPlotContainer.add(oNewImage);

                    }

                    oWindow.add(oPlotContainer);

                    oWindow.show();

                  }

                } else {

                  GLOBAL.APP.CF.alert(response.error, &quot;warning&quot;);

                }
                me.getContainer().body.unmask();
              },
              failure : function(oRequest) {
                GLOBAL.APP.CF.alert(&quot;Error: &quot; + oRequest.statusText, &quot;warning&quot;);
                me.getContainer().body.unmask();
              },
              params : {
                &#39;plotRequest&#39; : sViewRequest,
                &#39;timeLength&#39; : &#39;day&#39;,
                &#39;viewName&#39; : sViewName
              }
            });

      },
      __buildSystemViewer : function() {
        var me = this;

        me.systemPlotViewerMainPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              floatable : false,
              layout : &#39;border&#39;,
              header : false,
              border : false,
              defaults : {
                collapsible : true,
                split : true
              }
            });

        me.systemPlotsTreeStore = Ext.create(&#39;Ext.data.TreeStore&#39;, {
              model : &#39;DIRAC.ActivityMonitor.classes.ActivityTreeModel&#39;,
              fields : [&#39;text&#39;, &#39;component&#39;],
              scope : me,
              proxy : {
                type : &#39;ajax&#39;,
                url : GLOBAL.BASE_URL + &#39;ActivityMonitor/getDynamicPlotViews&#39;
              },
              root : {
                text : &#39;/&#39;,
                id : &#39;/Systems&#39;,
                expanded : true
              },
              folderSort : true,
              sorters : [{
                    property : &#39;text&#39;,
                    direction : &#39;ASC&#39;
                  }],
              listeners : {
                collapse : function(oNode, eOpts) {
                  me.__oprUnsetPathAsExpanded(me.__getNodePath(oNode), true);
                },
                expand : function(oNode, eOpts) {
                  me.__oprPathAsExpanded(me.__getNodePath(oNode), true)
                },
                scope : me
              }
            });

        me.systemPlotViewerTreePanel = Ext.create(&#39;Ext.tree.TreePanel&#39;, {
              region : &quot;west&quot;,
              width : 250,
              store : me.systemPlotsTreeStore,
              listeners : {
                itemclick : function(record, item, index, e, eOpts) {
                  console.log(record);
                  if (item.get(&#39;component&#39;) != &quot;&quot;) {
                    me.systemPlotViewerResultPanel.removeAll();
                    var varData = {
                      &quot;sources.componentName&quot; : item.get(&quot;component&quot;)
                    };
                    var oNewPlots = me.__buildPlotView(&quot;Dynamic component view&quot;, varData);

                    me.systemPlotViewerResultPanel.add(oNewPlots);

                  }
                }
              }
            });

        me.systemPlotViewerResultPanel = new Ext.create(&#39;Ext.panel.Panel&#39;, {
              floatable : false,
              region : &quot;center&quot;,
              layout : &quot;border&quot;,
              header : false,
              border : false,
              items : []
            });

        me.systemPlotViewerMainPanel.add([me.systemPlotViewerTreePanel, me.systemPlotViewerResultPanel]);
        me.mainPanel.add([me.systemPlotViewerMainPanel]);
      },
      __oprUnsetPathAsExpanded : function(sPath) {

        var me = this;
        var oParts = sPath.split(&quot;/&quot;);

        // The first element is always empty
        var oTemp = me.expansionState;
        var oStartIndex = 0;

        if (sPath == &quot;/&quot;)
          oStartIndex = 1;

        for (var i = oStartIndex; i &lt; oParts.length; i++) {

          if (oParts[i] in oTemp) {

            if (i == oParts.length - 1) {

              delete oTemp[oParts[i]];

            } else {

              oTemp = oTemp[oParts[i]];

            }

          }
        }

      },

      __oprPathAsExpanded : function(sPath, bInsertIntoStructure) {

        var me = this;
        var oParts = sPath.split(&quot;/&quot;);

        // The first element is always empty
        var oTemp = me.expansionState;
        var oFound = true;

        var oStartIndex = 0;

        if (sPath == &quot;/&quot;)
          oStartIndex = 1;

        for (var i = oStartIndex; i &lt; oParts.length; i++) {

          if (oParts[i] in oTemp) {

            oTemp = oTemp[oParts[i]];

          } else {

            oFound = false;

            if (bInsertIntoStructure) {
              oTemp[oParts[i]] = {};
            }

            break;

          }

        }

        return oFound;

      },
      __getNodePath : function(oNode) {
        var sPath = &quot;&quot;
        var oCopyRefNode = oNode;
        while (oCopyRefNode) {
          if (oCopyRefNode.raw.id)
            sPath = &quot;/&quot; + oCopyRefNode.raw.id + sPath;
          else
            break;
          oCopyRefNode = oCopyRefNode.parentNode;
        }
        if (!sPath)
          return &quot;/&quot;;
        return sPath;
      }

    });
</pre>
</body>
</html>
